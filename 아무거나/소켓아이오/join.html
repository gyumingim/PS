<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ’¬ ë‹‰ë„¤ì„ ì…ë ¥ - BABA CHAT</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ’¬ BABA CHAT</h1>
      <div class="header-controls">
        <div id="connectionStatus" style="background: var(--warning-color); color: var(--text-color); padding: 8px 12px; border-radius: 4px; border: 2px solid var(--text-color); font-size: 13px; font-family: inherit; font-weight: bold; margin-right: 15px;">ì—°ê²° ì¤‘...</div>
        <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™ ë‹¤í¬ëª¨ë“œ</button>
      </div>
    </div>

    <div class="main-content">
      <div class="room-select-screen">
        <div class="welcome-section">
          <h2>ë‹‰ë„¤ì„ ì„¤ì •</h2>
          <p><strong id="selectedRoomName"></strong> ë°©ì— ì…ì¥í•©ë‹ˆë‹¤</p>
        </div>
        
        <div class="create-room-form" style="max-width: 400px; margin: 0 auto;">
          <form onsubmit="event.preventDefault(); joinRoom(); return false;">
            <div class="form-group">
              <label>ë‹‰ë„¤ì„ (ìµœëŒ€ 20ì):</label>
              <input type="text" id="nameInput" placeholder="ì‚¬ìš©í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="20" autofocus>
              <div class="char-counter" id="nameCharCounter">0/20</div>
            </div>
            
            <button type="submit">ğŸ“ ë“¤ì–´ê°€ê¸°!</button>
            <button type="button" class="btn-secondary" onclick="backToRoomSelect()">â† ë’¤ë¡œê°€ê¸°</button>
          </form>
          <div id="joinError" class="error" style="display: none;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let socket;
    let currentRoom = null;

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
      // URLì—ì„œ ë°© ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
      const urlParams = new URLSearchParams(window.location.search);
      currentRoom = urlParams.get('room');
      
      if (!currentRoom) {
        // ë°© ì´ë¦„ì´ ì—†ìœ¼ë©´ ë°© ì„ íƒ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        window.location.href = 'rooms.html';
        return;
      }
      
      // ë°© ì´ë¦„ í‘œì‹œ
      document.getElementById('selectedRoomName').textContent = currentRoom;
      
      connectSocket();
      setupEventListeners();
      loadTheme();
    });

    // Socket.IO ì—°ê²°
    function connectSocket() {
      if (socket) return;
      
      try {
        socket = io('http://localhost:8000', {
          reconnection: true,
          reconnectionDelay: 1000,
          reconnectionAttempts: 5,
          timeout: 20000
        });

        socket.on('connect', () => {
          console.log('ğŸ”— ì„œë²„ì— ì—°ê²°ë¨');
          hideConnectionError();
          updateConnectionStatus('connected');
        });

        socket.on('connect_error', (error) => {
          console.error('âŒ ì—°ê²° ì‹¤íŒ¨:', error);
          updateConnectionStatus('error');
          showConnectionError('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
        });

        socket.on('disconnect', (reason) => {
          console.log('âŒ ì„œë²„ ì—°ê²° ëŠê¹€:', reason);
          updateConnectionStatus('disconnected');
          if (reason === 'io server disconnect') {
            socket.connect();
          }
        });

        socket.on('join_success', (data) => {
          console.log('âœ… ë°© ì…ì¥ ì„±ê³µ:', data);
          // ì±„íŒ… í˜ì´ì§€ë¡œ ì´ë™í•˜ë©´ì„œ ë°© ì •ë³´ì™€ ì‚¬ìš©ì ì •ë³´ ì „ë‹¬
          window.location.href = `chat.html?room=${encodeURIComponent(data.room)}&username=${encodeURIComponent(data.username)}`;
        });

        socket.on('error', (message) => {
          showError('joinError', message);
        });

      } catch (error) {
        console.error('âŒ Socket.IO ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        showConnectionError('ì—°ê²° ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ë°© ì…ì¥
    function joinRoom() {
      try {
        const username = document.getElementById('nameInput').value.trim();
        
        if (!username) {
          showError('joinError', 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        if (!currentRoom) {
          showError('joinError', 'ì„ íƒëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        if (!socket || !socket.connected) {
          showError('joinError', 'ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        console.log('ğŸš€ ë°© ì…ì¥ ìš”ì²­ ì „ì†¡:', { room: currentRoom, username: username });
        socket.emit('join', { room: currentRoom, username: username });
        
        // ë²„íŠ¼ ë¹„í™œì„±í™”
        const btn = event?.target || document.querySelector('button[type="submit"]');
        if (btn) {
          btn.disabled = true;
          btn.textContent = 'ì…ì¥ ì¤‘...';
          setTimeout(() => {
            btn.disabled = false;
            btn.textContent = 'ğŸ“ ë“¤ì–´ê°€ê¸°!';
          }, 3000);
        }
      } catch (error) {
        console.error('âŒ ë°© ì…ì¥ ì—ëŸ¬:', error);
        showError('joinError', 'ë°© ì…ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ë’¤ë¡œê°€ê¸°
    function backToRoomSelect() {
      window.location.href = 'rooms.html';
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    function setupEventListeners() {
      document.getElementById('nameInput').addEventListener('input', (e) => {
        updateCharCounter('nameInput', 'nameCharCounter', 20);
      });
    }

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    function showError(elementId, message) {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = message;
      errorElement.className = 'error';
      errorElement.style.display = 'block';
      setTimeout(() => {
        errorElement.style.display = 'none';
      }, 5000);
    }

    function showConnectionError(message) {
      let errorDiv = document.getElementById('connectionError');
      if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = 'connectionError';
        errorDiv.style.cssText = `
          position: fixed;
          top: 80px;
          left: 50%;
          transform: translateX(-50%);
          background: var(--danger-color);
          color: white;
          padding: 15px 25px;
          border-radius: 10px;
          z-index: 2000;
          box-shadow: var(--shadow-lg);
        `;
        document.body.appendChild(errorDiv);
      }
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    function hideConnectionError() {
      const errorDiv = document.getElementById('connectionError');
      if (errorDiv) {
        errorDiv.style.display = 'none';
      }
    }

    function updateConnectionStatus(status) {
      const statusDiv = document.getElementById('connectionStatus');
      if (!statusDiv) return;
      
      switch (status) {
        case 'connected':
          statusDiv.textContent = 'ğŸŸ¢ ì—°ê²°ë¨';
          statusDiv.style.background = 'var(--success-color)';
          break;
        case 'disconnected':
          statusDiv.textContent = 'ğŸ”´ ì—°ê²° ëŠê¹€';
          statusDiv.style.background = 'var(--danger-color)';
          break;
        case 'error':
          statusDiv.textContent = 'âš ï¸ ì—°ê²° ì˜¤ë¥˜';
          statusDiv.style.background = 'var(--danger-color)';
          break;
        default:
          statusDiv.textContent = 'ğŸŸ¡ ì—°ê²° ì¤‘...';
          statusDiv.style.background = 'var(--warning-color)';
      }
    }

    function updateCharCounter(inputId, counterId, maxLength) {
      const input = document.getElementById(inputId);
      const counter = document.getElementById(counterId);
      const length = input.value.length;
      
      counter.textContent = `${length}/${maxLength}`;
      
      counter.classList.remove('warning', 'danger');
      if (length > maxLength * 0.8) {
        counter.classList.add('warning');
      }
      if (length > maxLength * 0.95) {
        counter.classList.add('danger');
      }
    }

    function toggleTheme() {
      const body = document.body;
      const currentTheme = body.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      const themeBtn = document.querySelector('.theme-toggle');
      themeBtn.textContent = newTheme === 'dark' ? 'â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ' : 'ğŸŒ™ ë‹¤í¬ëª¨ë“œ';
    }

    function loadTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.body.setAttribute('data-theme', savedTheme);
      
      const themeBtn = document.querySelector('.theme-toggle');
      themeBtn.textContent = savedTheme === 'dark' ? 'â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ' : 'ğŸŒ™ ë‹¤í¬ëª¨ë“œ';
    }
  </script>
</body>
</html>