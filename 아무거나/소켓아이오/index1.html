<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ’¬ ì‹¬í”Œ ì±„íŒ…</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* Baba is You ìŠ¤íƒ€ì¼ íŒŒìŠ¤í…” íŒ”ë ˆíŠ¸ */
      --primary-color: #7dd3fc;
      --primary-hover: #38bdf8;
      --secondary-color: #fbbf24;
      --success-color: #86efac;
      --success-hover: #4ade80;
      --danger-color: #fca5a5;
      --danger-hover: #f87171;
      --warning-color: #fed7aa;
      --info-color: #a5b4fc;
      
      /* ë¼ì´íŠ¸ í…Œë§ˆ */
      --bg-color: #f8fafc;
      --card-bg: #ffffff;
      --text-color: #1e293b;
      --text-muted: #64748b;
      --border-color: #e2e8f0;
      --input-bg: #ffffff;
      --message-bg: #f1f5f9;
      --own-message-bg: #7dd3fc;
      --own-message-text: #1e293b;
      --system-message-bg: #e0e7ff;
      --typing-bg: #fef3c7;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 4px 6px rgba(0, 0, 0, 0.1);
      --mention-bg: #fce7f3;
      --mention-color: #be185d;
      --reaction-bg: #dcfce7;
      --reaction-border: #86efac;
    }

    [data-theme="dark"] {
      --bg-color: #0f172a;
      --card-bg: #1e293b;
      --text-color: #f8fafc;
      --text-muted: #94a3b8;
      --border-color: #334155;
      --input-bg: #334155;
      --message-bg: #334155;
      --system-message-bg: #3730a3;
      --typing-bg: #451a03;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 4px 6px rgba(0, 0, 0, 0.3);
      --mention-bg: #831843;
      --mention-color: #fce7f3;
      --reaction-bg: #14532d;
      --reaction-border: #86efac;
    }

    body {
      font-family: 'Courier New', monospace;
      margin: 0;
      padding: 0;
      background: var(--bg-color);
      color: var(--text-color);
      transition: all 0.2s ease;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: var(--card-bg);
      box-shadow: var(--shadow-lg);
    }

    .header {
      background: var(--primary-color);
      color: var(--text-color);
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 3px solid var(--border-color);
      z-index: 100;
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--text-color);
      margin: 0;
    }

    .header-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .theme-toggle, .search-toggle {
      background: var(--secondary-color);
      border: 2px solid var(--text-color);
      color: var(--text-color);
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s;
    }

    .theme-toggle:hover, .search-toggle:hover {
      background: var(--warning-color);
      transform: none;
    }

    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .screen {
      display: none;
      flex: 1;
      flex-direction: column;
    }

    .screen.active {
      display: flex;
    }

    /* ê²€ìƒ‰ íŒ¨ë„ */
    .search-panel {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100vh;
      background: var(--card-bg);
      box-shadow: var(--shadow-lg);
      z-index: 200;
      transition: right 0.3s ease;
      border-left: 1px solid var(--border-color);
    }

    .search-panel.active {
      right: 0;
    }

    .search-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      background: var(--message-bg);
    }

    .search-input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .search-input {
      flex: 1;
      padding: 12px;
      border: 2px solid var(--border-color);
      border-radius: 25px;
      background: var(--input-bg);
      color: var(--text-color);
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .search-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .search-btn:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .search-results {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .search-result-item {
      padding: 15px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background 0.2s;
    }

    .search-result-item:hover {
      background: var(--message-bg);
    }

    .search-result-content {
      font-size: 14px;
      margin-bottom: 5px;
    }

    .search-result-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    .search-highlight {
      background: var(--warning-color);
      color: white;
      padding: 2px 4px;
      border-radius: 3px;
    }

    /* ë°© ì„ íƒ í™”ë©´ */
    .room-select-screen {
      padding: 30px;
      overflow-y: auto;
      background: linear-gradient(135deg, var(--bg-color), var(--message-bg));
    }

    .welcome-section {
      text-align: center;
      margin-bottom: 40px;
    }

    .welcome-section h2 {
      font-size: 2rem;
      margin-bottom: 10px;
      color: var(--text-color);
      font-weight: bold;
    }

    .welcome-section p {
      color: var(--text-muted);
      font-size: 1.1rem;
    }

    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .refresh-btn {
      background: var(--success-color);
      color: var(--text-color);
      border: 3px solid var(--text-color);
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      font-family: inherit;
      transition: background-color 0.2s;
    }

    .refresh-btn:hover {
      background: var(--secondary-color);
    }

    .room-list {
      margin-bottom: 40px;
    }

    .room-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border: 3px solid var(--border-color);
      border-radius: 4px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: border-color 0.2s;
      background: var(--card-bg);
    }

    .room-item:hover {
      background: var(--message-bg);
      border-color: var(--primary-color);
    }

    .room-info h3 {
      margin: 0;
      color: var(--text-color);
      font-size: 1.2rem;
      font-weight: 600;
    }

    .room-info p {
      margin: 8px 0 0 0;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .user-count {
      background: var(--info-color);
      color: var(--text-color);
      padding: 6px 12px;
      border-radius: 4px;
      border: 2px solid var(--text-color);
      font-size: 0.9rem;
      font-weight: bold;
      font-family: inherit;
    }

    .create-room-form {
      background: var(--card-bg);
      padding: 24px;
      border-radius: 4px;
      border: 3px solid var(--border-color);
    }

    .create-room-form h3 {
      margin-bottom: 20px;
      color: var(--text-color);
      font-size: 1.4rem;
      font-weight: 700;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-color);
    }

    input[type="text"], textarea {
      width: 100%;
      padding: 12px;
      border: 3px solid var(--border-color);
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
      background: var(--input-bg);
      color: var(--text-color);
      transition: border-color 0.2s;
    }

    input[type="text"]:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    button {
      background: var(--success-color);
      color: var(--text-color);
      border: 3px solid var(--text-color);
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-family: inherit;
      font-weight: bold;
      transition: background-color 0.2s;
    }

    button:hover:not(:disabled) {
      background: var(--secondary-color);
    }

    button:disabled {
      background: var(--text-muted);
      border-color: var(--text-muted);
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--text-muted);
      margin-left: 15px;
    }

    .btn-danger {
      background: var(--danger-color);
    }

    /* ì±„íŒ… í™”ë©´ */
    .chat-layout {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 25px;
      border-bottom: 1px solid var(--border-color);
      background: var(--message-bg);
      box-shadow: var(--shadow);
    }

    .chat-info h3 {
      margin: 0;
      color: var(--text-color);
      font-size: 1.3rem;
      font-weight: 700;
    }

    .chat-info p {
      margin: 5px 0 0 0;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: var(--bg-color);
    }

    .load-more-btn {
      align-self: center;
      background: var(--info-color);
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 13px;
      margin-bottom: 15px;
    }

    .message {
      display: flex;
      flex-direction: column;
      max-width: 70%;
      word-wrap: break-word;
      position: relative;
    }

    .message.own {
      align-self: flex-end;
    }

    .message.system {
      align-self: center;
      max-width: 80%;
    }

    .message.mention {
      background: var(--mention-bg);
      border-left: 4px solid var(--mention-color);
      padding-left: 15px;
      border-radius: 10px;
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .message.own .message-header {
      justify-content: flex-end;
    }

    .message.system .message-header {
      justify-content: center;
    }

    .message-username {
      font-weight: 700;
      color: var(--primary-color);
    }

    .message-timestamp {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .message-content {
      padding: 12px 16px;
      border-radius: 4px;
      background: var(--message-bg);
      color: var(--text-color);
      line-height: 1.4;
      position: relative;
      border: 2px solid var(--border-color);
    }

    .message.own .message-content {
      background: var(--own-message-bg);
      color: var(--own-message-text);
      border-color: var(--primary-hover);
    }

    .message.system .message-content {
      background: var(--system-message-bg);
      text-align: center;
      font-style: italic;
      border-radius: 4px;
    }

    .message-reactions {
      display: flex;
      gap: 5px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .reaction {
      display: flex;
      align-items: center;
      gap: 4px;
      background: var(--reaction-bg);
      border: 1px solid var(--reaction-border);
      padding: 4px 8px;
      border-radius: 15px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .reaction:hover {
      transform: scale(1.05);
    }

    .reaction.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .message-actions {
      position: absolute;
      top: -10px;
      right: 10px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 5px;
      opacity: 0;
      transition: opacity 0.2s;
      box-shadow: var(--shadow);
    }

    .message:hover .message-actions {
      opacity: 1;
    }

    .reaction-btn {
      background: none;
      border: none;
      padding: 5px 8px;
      cursor: pointer;
      font-size: 16px;
      border-radius: 10px;
      transition: background 0.2s;
    }

    .reaction-btn:hover {
      background: var(--message-bg);
    }

    .typing-indicator {
      padding: 15px 25px;
      background: var(--typing-bg);
      border-top: 1px solid var(--border-color);
      font-size: 0.9rem;
      color: var(--text-color);
      min-height: 50px;
      display: flex;
      align-items: center;
    }

    .typing-indicator.hidden {
      display: none;
    }

    .typing-dots {
      display: inline-flex;
      gap: 3px;
      margin-left: 8px;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      background: var(--primary-color);
      border-radius: 50%;
      animation: typingBounce 1.4s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingBounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }

    .message-input-area {
      display: flex;
      padding: 20px 25px;
      gap: 15px;
      border-top: 1px solid var(--border-color);
      background: var(--card-bg);
      align-items: flex-end;
    }

    .input-wrapper {
      flex: 1;
      position: relative;
    }

    #msgInput {
      width: 100%;
      min-height: 50px;
      max-height: 120px;
      resize: none;
      border: 2px solid var(--border-color);
      border-radius: 25px;
      padding: 15px 60px 15px 20px;
      font-size: 14px;
      background: var(--input-bg);
      color: var(--text-color);
      line-height: 1.4;
      transition: border-color 0.3s;
    }

    #msgInput:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .input-actions {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      gap: 5px;
    }

    .emoji-btn, .mention-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .emoji-btn:hover, .mention-btn:hover {
      background: var(--message-bg);
      transform: scale(1.1);
    }

    .char-counter {
      position: absolute;
      bottom: -25px;
      right: 15px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .char-counter.warning { color: var(--warning-color); }
    .char-counter.danger { color: var(--danger-color); }

    .emoji-picker {
      position: absolute;
      bottom: 60px;
      right: 15px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 15px;
      padding: 15px;
      display: none;
      grid-template-columns: repeat(8, 1fr);
      gap: 8px;
      z-index: 1000;
      box-shadow: var(--shadow-lg);
      max-width: 320px;
      max-height: 240px;
      overflow-y: auto;
    }

    .emoji-picker.show { display: grid; }

    .emoji-item {
      background: none;
      border: none;
      font-size: 24px;
      padding: 8px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .emoji-item:hover {
      background: var(--message-bg);
      transform: scale(1.2);
    }

    /* ë©˜ì…˜ ìë™ì™„ì„± */
    .mention-dropdown {
      position: absolute;
      bottom: 60px;
      left: 20px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      display: none;
    }

    .mention-dropdown.show { display: block; }

    .mention-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .mention-item:hover, .mention-item.selected {
      background: var(--primary-color);
      color: white;
    }

    .mention-avatar {
      width: 24px;
      height: 24px;
      background: var(--primary-color);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: 600;
    }

    /* ì‚¬ìš©ì ëª©ë¡ */
    .user-list-panel {
      width: 280px;
      background: var(--message-bg);
      border-left: 1px solid var(--border-color);
      padding: 25px;
      overflow-y: auto;
      flex-shrink: 0;
    }

    .user-list-header {
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--text-color);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.1rem;
    }

    .online-indicator {
      width: 10px;
      height: 10px;
      background: var(--success-color);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(72, 187, 120, 0); }
      100% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0); }
    }

    .user-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      color: var(--text-color);
      border-bottom: 1px solid var(--border-color);
      transition: all 0.2s;
    }

    .user-item:hover {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 12px;
      margin: 0 -12px;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      background: var(--primary-color);
      border-radius: 4px;
      border: 2px solid var(--text-color);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-color);
      font-weight: bold;
      font-size: 1rem;
      font-family: inherit;
    }

    .user-name {
      flex: 1;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .user-status {
      font-size: 0.8rem;
      color: var(--text-muted);
      font-style: italic;
    }

    /* ëª¨ë‹¬ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 300;
      backdrop-filter: blur(5px);
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal h3 {
      margin-bottom: 20px;
      color: var(--text-color);
      font-size: 1.5rem;
      font-weight: 700;
    }

    .modal-close {
      float: right;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-muted);
      padding: 0;
      margin-top: -10px;
    }

    .modal-close:hover {
      color: var(--danger-color);
    }

    .error {
      color: var(--danger-color);
      margin-top: 15px;
      padding: 15px;
      background: rgba(245, 101, 101, 0.1);
      border: 1px solid rgba(245, 101, 101, 0.3);
      border-radius: 10px;
      font-size: 0.9rem;
    }

    .success {
      color: var(--success-color);
      margin-top: 15px;
      padding: 15px;
      background: rgba(72, 187, 120, 0.1);
      border: 1px solid rgba(72, 187, 120, 0.3);
      border-radius: 10px;
      font-size: 0.9rem;
    }

    .empty-rooms {
      text-align: center;
      color: var(--text-muted);
      padding: 50px 20px;
    }

    .empty-rooms h3 {
      margin-bottom: 15px;
      color: var(--text-color);
      font-size: 1.3rem;
    }

    .empty-rooms .icon {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    /* ë°˜ì‘í˜• ë””ìì¸ */
    @media (max-width: 1024px) {
      .search-panel {
        width: 350px;
      }
      
      .user-list-panel {
        width: 250px;
      }
    }

    @media (max-width: 768px) {
      .container {
        border-radius: 0;
        margin: 0;
      }

      .header {
        padding: 12px 20px;
      }

      .header h1 {
        font-size: 1.4rem;
      }

      .chat-layout {
        flex-direction: column;
      }

      .user-list-panel {
        width: 100%;
        max-height: 200px;
        border-left: none;
        border-top: 1px solid var(--border-color);
        order: 2;
      }

      .chat-main {
        order: 1;
      }

      .message {
        max-width: 85%;
      }

      .room-select-screen {
        padding: 20px;
      }

      .controls {
        flex-direction: column;
      }

      .message-input-area {
        padding: 15px 20px;
      }

      .search-panel {
        width: 100%;
        right: -100%;
      }

      .emoji-picker {
        position: fixed;
        bottom: 80px;
        right: 20px;
        left: 20px;
        max-width: none;
      }
    }

    @media (max-width: 480px) {
      .header {
        padding: 10px 15px;
      }

      .chat-messages {
        padding: 15px 20px;
      }

      .message-input-area {
        padding: 12px 15px;
      }

      .user-list-panel {
        padding: 20px;
      }

      .welcome-section h2 {
        font-size: 2rem;
      }
    }

    /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ */
    ::-webkit-scrollbar {
      width: 12px;
    }

    ::-webkit-scrollbar-track {
      background: var(--message-bg);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border: 2px solid var(--text-color);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--secondary-color);
    }

    /* ì• ë‹ˆë©”ì´ì…˜ */
    .message {
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .room-item, .user-item {
      animation: fadeIn 0.2s ease-out;
    }

    /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ’¬ BABA CHAT</h1>
      <div class="header-controls">
        <div id="connectionStatus" style="background: var(--warning-color); color: var(--text-color); padding: 8px 12px; border-radius: 4px; border: 2px solid var(--text-color); font-size: 13px; font-family: inherit; font-weight: bold; margin-right: 15px;">ì—°ê²° ì¤‘...</div>
        <button class="search-toggle" onclick="toggleSearchPanel()" style="display: none;">ğŸ” ê²€ìƒ‰</button>
        <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™ ë‹¤í¬ëª¨ë“œ</button>
      </div>
    </div>

    <!-- ê²€ìƒ‰ íŒ¨ë„ -->
    <div class="search-panel" id="searchPanel">
      <div class="search-header">
        <div class="search-input-group">
          <input type="text" class="search-input" id="searchInput" placeholder="ë©”ì‹œì§€ ê²€ìƒ‰...">
          <button class="search-btn" onclick="searchMessages()">ê²€ìƒ‰</button>
        </div>
        <button onclick="toggleSearchPanel()" style="background: var(--text-muted); padding: 8px 15px; border-radius: 15px;">ë‹«ê¸°</button>
      </div>
      <div class="search-results" id="searchResults">
        <p style="text-align: center; color: var(--text-muted); padding: 40px;">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì—¬ ë©”ì‹œì§€ë¥¼ ì°¾ì•„ë³´ì„¸ìš”</p>
      </div>
    </div>

    <div class="main-content">
      <!-- ë°© ì„ íƒ í™”ë©´ -->
      <div id="roomSelectScreen" class="screen room-select-screen active">
        <div class="welcome-section">
          <h2>HELLO IS YOU!</h2>
          <p>ì‹¬í”Œí•˜ê³  ê·€ì—¬ìš´ ì±„íŒ…ë°© ğŸŒ¸</p>
        </div>
        
        <div class="controls">
          <button class="refresh-btn" onclick="refreshRooms()">ğŸ”„ ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        
        <div class="room-list">
          <div id="roomsList">
            <div class="empty-rooms">
              <div class="icon">ğŸ </div>
              <h3>ë°©ì´ ì—†ì–´ìš”!</h3>
              <p>ìƒˆë¡œìš´ ë°©ì„ ë§Œë“¤ì–´ì„œ ì¹œêµ¬ë“¤ê³¼ ìˆ˜ë‹¤ ë–¨ì–´ìš”~</p>
            </div>
          </div>
        </div>

        <div class="create-room-form">
          <h3>ğŸ  ìƒˆ ë°© ë§Œë“¤ê¸°</h3>
          <form onsubmit="event.preventDefault(); createRoom(); return false;">
            <div class="form-group">
              <label>ë°© ì´ë¦„ (ìµœëŒ€ 30ì):</label>
              <input type="text" id="newRoomInput" placeholder="ì˜ˆ: ììœ ì±„íŒ…, ê°œë°œí† ë¡ , ê²Œì„ë°© ë“±" maxlength="30">
              <div class="char-counter" id="roomCharCounter">0/30</div>
            </div>
            <button type="submit">ğŸ  ë§Œë“¤ê¸°!</button>
          </form>
          <div id="createRoomError" class="error" style="display: none;"></div>
        </div>
      </div>

      <!-- ë‹‰ë„¤ì„ ì…ë ¥ í™”ë©´ -->
      <div id="nameInputScreen" class="screen room-select-screen">
        <div class="welcome-section">
          <h2>ë‹‰ë„¤ì„ ì„¤ì •</h2>
          <p><strong id="selectedRoomName"></strong> ë°©ì— ì…ì¥í•©ë‹ˆë‹¤</p>
        </div>
        
        <div class="create-room-form" style="max-width: 400px; margin: 0 auto;">
          <form onsubmit="event.preventDefault(); joinRoom(); return false;">
            <div class="form-group">
              <label>ë‹‰ë„¤ì„ (ìµœëŒ€ 20ì):</label>
              <input type="text" id="nameInput" placeholder="ì‚¬ìš©í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="20">
              <div class="char-counter" id="nameCharCounter">0/20</div>
            </div>
            
            <button type="submit">ğŸ“ ë“¤ì–´ê°€ê¸°!</button>
            <button type="button" class="btn-secondary" onclick="backToRoomSelect()">â† ë’¤ë¡œê°€ê¸°</button>
          </form>
          <div id="joinError" class="error" style="display: none;"></div>
        </div>
      </div>

      <!-- ì±„íŒ… í™”ë©´ -->
      <div id="chatScreen" class="screen">
        <div class="chat-layout">
          <div class="chat-main">
            <div class="chat-header">
              <div class="chat-info">
                <h3 id="currentRoomName"></h3>
                <p>ğŸ‘¤ <span id="currentUserName"></span></p>
              </div>
              <button class="btn-danger" onclick="leaveRoom()">ğŸ‘‹ ë‚˜ê°€ê¸°</button>
            </div>
            
            <div class="chat-messages" id="messages">
              <button class="load-more-btn" id="loadMoreBtn" onclick="loadMoreMessages()" style="display: none;">
                ğŸ“œ ì´ì „ ë©”ì‹œì§€ ë” ë³´ê¸°
              </button>
            </div>
            
            <div class="typing-indicator hidden" id="typingIndicator">
              <span id="typingText"></span>
              <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
              </div>
            </div>
            
            <form class="message-input-area" onsubmit="event.preventDefault(); sendMessage(); return false;">
              <div class="input-wrapper">
                <textarea id="msgInput" placeholder="ì—¬ê¸°ì— ë©”ì‹œì§€ ì…ë ¥í•˜ì„¸ìš”~ (ìµœëŒ€ 500ì)" 
                         disabled rows="1" maxlength="500"></textarea>
                <div class="input-actions">
                  <button type="button" class="mention-btn" onclick="showMentionDropdown()" title="ë©˜ì…˜">@</button>
                  <button type="button" class="emoji-btn" onclick="toggleEmojiPicker()" title="ì´ëª¨ì§€">ğŸ˜€</button>
                </div>
                <div class="char-counter" id="msgCharCounter">0/500</div>
                <div class="emoji-picker" id="emojiPicker"></div>
                <div class="mention-dropdown" id="mentionDropdown"></div>
              </div>
              <button type="submit" id="sendBtn" disabled>ğŸ’Œ</button>
            </form>
          </div>
          
          <div class="user-list-panel">
            <div class="user-list-header">
              <span class="online-indicator"></span>
              ì˜¨ë¼ì¸ (<span id="userCount">0</span>)
            </div>
            <div id="userList"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ë°˜ì‘ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="reactionModal">
    <div class="modal">
      <button class="modal-close" onclick="closeReactionModal()">Ã—</button>
      <h3>ë°˜ì‘ ì„ íƒ</h3>
      <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-top: 20px;">
        <button class="emoji-item" onclick="addReaction('ğŸ‘')">ğŸ‘</button>
        <button class="emoji-item" onclick="addReaction('â¤ï¸')">â¤ï¸</button>
        <button class="emoji-item" onclick="addReaction('ğŸ˜‚')">ğŸ˜‚</button>
        <button class="emoji-item" onclick="addReaction('ğŸ˜®')">ğŸ˜®</button>
        <button class="emoji-item" onclick="addReaction('ğŸ˜¢')">ğŸ˜¢</button>
        <button class="emoji-item" onclick="addReaction('ğŸ˜¡')">ğŸ˜¡</button>
        <button class="emoji-item" onclick="addReaction('ğŸ‰')">ğŸ‰</button>
        <button class="emoji-item" onclick="addReaction('ğŸ”¥')">ğŸ”¥</button>
        <button class="emoji-item" onclick="addReaction('ğŸ’¯')">ğŸ’¯</button>
        <button class="emoji-item" onclick="addReaction('âœ¨')">âœ¨</button>
        <button class="emoji-item" onclick="addReaction('âš¡')">âš¡</button>
        <button class="emoji-item" onclick="addReaction('ğŸš€')">ğŸš€</button>
      </div>
    </div>
  </div>

  <!-- ì˜¤ë””ì˜¤ ì•Œë¦¼ -->
  <audio id="notificationSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmRKBCZ+yO/fjUELEF2779mqWBUJQJvZ8LhmHwU7k9n1s2oXrBkieiTL7YvWDRBfru7cfjBdOABHVhDGDoCsZRQNStLznWElBSGB0fDNeSsFJIHO8diKOQcZZrrr4J5NEAxPquPwtGQeBzt9z/HOeSsFJYLN8deJOAgYZLjq5J9OEwxOoOXgujZgdQ2Q0n5sHAVFs4DyiGQNA6XG9faNTW0QAWB82Q+j7Z+Qjf/PQcOJQg0PU6vj5vgqCj6SzfONdysNJ3bG8N2POAoUYqjv3qtWFAxFnuLgmnXO9QdP5sxpHTMg9QdS68JoHTSJyfSFSSIKPHjI8diONglxe6b0vQ==" type="audio/wav">
  </audio>

  <script>
    let socket;
    let currentRoom = null;
    let currentUsername = null;
    let currentUserId = null;
    let typingTimer = null;
    let isTyping = false;
    let soundEnabled = true;
    let messageOffset = 0;
    let selectedReactionMessageId = null;
    let allUsers = [];
    let mentionIndex = -1;
    let filteredUsers = [];
    let lastScreen = 'roomSelectScreen';

    // ì´ëª¨ì§€ ëª©ë¡ (í™•ì¥ë¨)
    const emojis = [
      'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£',
      'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°',
      'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ',
      'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜',
      'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£',
      'ğŸ˜–', 'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ',
      'ğŸ˜¡', 'ğŸ¤¬', 'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨',
      'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜“', 'ğŸ¤—', 'ğŸ¤”', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤¥',
      'ğŸ‘‹', 'ğŸ¤š', 'ğŸ–', 'âœ‹', 'ğŸ––', 'ğŸ‘Œ', 'ğŸ¤Œ', 'ğŸ¤',
      'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†',
      'ğŸ‘‡', 'â˜ï¸', 'ğŸ‘', 'ğŸ‘', 'ğŸ‘Š', 'âœŠ', 'ğŸ¤›', 'ğŸ¤œ',
      'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™', 'ğŸ’ª', 'ğŸ¦¾',
      'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ¤', 'ğŸ–¤',
      'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’–', 'ğŸ’—', 'ğŸ’˜', 'ğŸ’',
      'ğŸ’', 'ğŸ’Ÿ', 'ğŸ”¥', 'âœ¨', 'ğŸ’«', 'â­', 'ğŸŒŸ', 'ğŸ’¥',
      'ğŸ’¯', 'ğŸ’¢', 'ğŸ’¨', 'ğŸ’¦', 'ğŸ’¤', 'ğŸ‰', 'ğŸŠ', 'ğŸˆ',
      'ğŸ', 'ğŸ€', 'ğŸ‚', 'ğŸ„', 'ğŸ†', 'ğŸ‡', 'ğŸ§¨', 'âœ¨',
      'ğŸƒ', 'ğŸ—ï¸', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ†', 'ğŸ“¢', 'âš¡',
      'ğŸ””', 'ğŸ”•', 'ğŸµ', 'ğŸ¶', 'ğŸ’¬', 'ğŸ’­', 'ğŸ—¯ï¸', 'ğŸ’¡',
      'ğŸš€', 'ğŸ›¸', 'ğŸŒ', 'ğŸŒ', 'ğŸŒ', 'ğŸŒ•', 'ğŸŒ–', 'ğŸŒ—'
    ];

    // ë¹ ë¥¸ ë°˜ì‘ ì´ëª¨ì§€
    const quickReactions = ['ğŸ‘', 'â¤ï¸', 'ğŸ˜‚', 'ğŸ˜®', 'ğŸ˜¢', 'ğŸ˜¡'];

        // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
      initializeEmojiPicker();
      connectSocket();
      setupEventListeners();
      loadTheme();
      
      // ê¸°ë³¸ í™”ë©´ í‘œì‹œ (íˆìŠ¤í† ë¦¬ ê´€ë¦¬ ì—†ì´)
      showScreen('roomSelectScreen', false);
      
      // í…ìŠ¤íŠ¸ ì˜ì—­ ìë™ í¬ê¸° ì¡°ì •
    const msgInput = document.getElementById('msgInput');
      msgInput.addEventListener('input', autoResizeTextarea);
    });

    // Socket.IO ì—°ê²°
    function connectSocket() {
      if (socket) return;
      
      try {
        socket = io('http://localhost:8000', {
          reconnection: true,
          reconnectionDelay: 1000,
          reconnectionAttempts: 5,
          timeout: 20000
        });

      socket.on('connect', () => {
          console.log('ğŸ”— ì„œë²„ì— ì—°ê²°ë¨');
          hideConnectionError();
          updateConnectionStatus('connected');
          socket.emit('get_rooms');
        });

        socket.on('connect_error', (error) => {
          console.error('âŒ ì—°ê²° ì‹¤íŒ¨:', error);
          updateConnectionStatus('error');
          showConnectionError('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
        });

        socket.on('disconnect', (reason) => {
          console.log('âŒ ì„œë²„ ì—°ê²° ëŠê¹€:', reason);
          updateConnectionStatus('disconnected');
          if (reason === 'io server disconnect') {
            // ì„œë²„ì—ì„œ ì—°ê²°ì„ ëŠì€ ê²½ìš° ì¬ì—°ê²° ì‹œë„
            socket.connect();
          }
        });
      } catch (error) {
        console.error('âŒ Socket.IO ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        showConnectionError('ì—°ê²° ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
      
      socket.on('rooms_list', (rooms) => {
        updateRoomsList(rooms);
      });

      socket.on('room_created', (data) => {
        console.log('ğŸ  ë°© ìƒì„±ë¨:', data.room_id);
        document.getElementById('newRoomInput').value = '';
        updateCharCounter('newRoomInput', 'roomCharCounter', 30);
        showSuccess('createRoomError', 'ë°©ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
      });

      socket.on('join_success', (data) => {
        try {
          console.log('âœ… ë°© ì…ì¥ ì„±ê³µ:', data);
          
          currentRoom = data.room;
          currentUsername = data.username;
          currentUserId = socket.id;
          
          // UI ì—…ë°ì´íŠ¸
          const roomNameEl = document.getElementById('currentRoomName');
          const userNameEl = document.getElementById('currentUserName');
          const msgInput = document.getElementById('msgInput');
          const sendBtn = document.getElementById('sendBtn');
          const messagesEl = document.getElementById('messages');
          const searchToggle = document.querySelector('.search-toggle');
          
          if (roomNameEl) roomNameEl.textContent = currentRoom;
          if (userNameEl) userNameEl.textContent = currentUsername;
          if (msgInput) msgInput.disabled = false;
          if (sendBtn) sendBtn.disabled = false;
          if (messagesEl) messagesEl.innerHTML = '';
          if (searchToggle) searchToggle.style.display = 'block';
          
          messageOffset = 0;
          showScreen('chatScreen');
          
          // ì‚¬ìš©ì ëª©ë¡ ìš”ì²­
          if (socket && socket.connected) {
            socket.emit('get_user_list', { room_id: currentRoom });
          }
          
          console.log('ğŸ‰ ì±„íŒ…ë°© UI ì´ˆê¸°í™” ì™„ë£Œ');
        } catch (error) {
          console.error('âŒ ë°© ì…ì¥ ì²˜ë¦¬ ì—ëŸ¬:', error);
          showError('joinError', 'ë°© ì…ì¥ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      });

      socket.on('message_history', (history) => {
        // íˆìŠ¤í† ë¦¬ ë©”ì‹œì§€ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì¶”ê°€
        history.forEach(msg => addMessageToDOM(msg, false));
        scrollToBottom();
      });

      socket.on('leave_success', () => {
        console.log('âœ… ë°© ë‚˜ê°€ê¸° ì„±ê³µ');
        
        // ìƒíƒœ ì´ˆê¸°í™”
        currentRoom = null;
        currentUsername = null;
        currentUserId = null;
        
        // UI ì´ˆê¸°í™”
        const msgInput = document.getElementById('msgInput');
        const sendBtn = document.getElementById('sendBtn');
        const searchToggle = document.querySelector('.search-toggle');
        
        if (msgInput) msgInput.disabled = true;
        if (sendBtn) sendBtn.disabled = true;
        if (searchToggle) searchToggle.style.display = 'none';
        
        clearTypingIndicator();
        
        // ë°© ì„ íƒ í™”ë©´ìœ¼ë¡œ ì´ë™
        showScreen('roomSelectScreen');
      });

      socket.on('message', (data) => {
        addMessage(data);
        
        // ì•Œë¦¼ ì‚¬ìš´ë“œ ì¬ìƒ (ìì‹ ì˜ ë©”ì‹œì§€ê°€ ì•„ë‹Œ ê²½ìš°)
        if (data.type === 'user' && data.user_id !== currentUserId && soundEnabled) {
          playNotificationSound();
        }
      });

      socket.on('user_list', (users) => {
        allUsers = users;
        updateUserList(users);
      });

      socket.on('typing_status', (data) => {
        updateTypingIndicator(data.users);
      });

      socket.on('search_results', (data) => {
        displaySearchResults(data.results, data.query);
      });

      socket.on('more_messages', (data) => {
        if (data.messages.length > 0) {
          const messagesContainer = document.getElementById('messages');
          const oldScrollHeight = messagesContainer.scrollHeight;
          
          // ë©”ì‹œì§€ë“¤ì„ ë§¨ ìœ„ì— ì¶”ê°€
          data.messages.reverse().forEach(msg => {
            addMessageToDOM(msg, true);
          });
          
          // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ìœ ì§€
          messagesContainer.scrollTop = messagesContainer.scrollHeight - oldScrollHeight;
          messageOffset = data.offset;
        } else {
          document.getElementById('loadMoreBtn').style.display = 'none';
        }
      });

      socket.on('reaction_updated', (data) => {
        updateMessageReactions(data.message_id, data.reactions);
      });

      socket.on('mention_notification', (data) => {
        showMentionNotification(data);
      });

      socket.on('error', (message) => {
        const activeScreen = document.querySelector('.screen.active').id;
        let errorElementId = 'createRoomError';
        
        if (activeScreen === 'nameInputScreen') {
          errorElementId = 'joinError';
        }
        
        showError(errorElementId, message);
      });

      socket.on('disconnect', () => {
        console.log('âŒ ì„œë²„ ì—°ê²° ëŠê¹€');
      });
    }

    // í™”ë©´ ì „í™˜ í•¨ìˆ˜ë“¤ (ë‹¨ìˆœí™”ë¨)
    function showScreen(screenId, addToHistory = false) {
      // ê°™ì€ í™”ë©´ìœ¼ë¡œ ì „í™˜ ì‹œë„í•˜ëŠ” ê²½ìš° ë¬´ì‹œ
      if (lastScreen === screenId && document.getElementById(screenId)?.classList.contains('active')) {
        return;
      }
      
      console.log('ğŸ“± í™”ë©´ ì „í™˜:', screenId);
      
      // í˜„ì¬ í™”ë©´ ìˆ¨ê¸°ê¸°
      document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
      });
      
      // ìƒˆ í™”ë©´ í‘œì‹œ
      const targetScreen = document.getElementById(screenId);
      if (targetScreen) {
        targetScreen.classList.add('active');
        lastScreen = screenId;
        
        // í™”ë©´ë³„ ì¶”ê°€ ì²˜ë¦¬
        handleScreenTransition(screenId);
      } else {
        console.error('âŒ í™”ë©´ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:', screenId);
      }
    }

    // í™”ë©´ ì „í™˜ ì‹œ ì¶”ê°€ ì²˜ë¦¬
    function handleScreenTransition(screenId) {
      switch (screenId) {
        case 'nameInputScreen':
          // ë‹‰ë„¤ì„ ì…ë ¥ì°½ í¬ì»¤ìŠ¤
          setTimeout(() => {
            const nameInput = document.getElementById('nameInput');
            if (nameInput) nameInput.focus();
          }, 100);
          break;
        case 'chatScreen':
          // ë©”ì‹œì§€ ì…ë ¥ì°½ í¬ì»¤ìŠ¤
          setTimeout(() => {
            const msgInput = document.getElementById('msgInput');
            if (msgInput && !msgInput.disabled) msgInput.focus();
          }, 100);
          break;
      }
    }

    function showError(elementId, message) {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = message;
      errorElement.className = 'error';
      errorElement.style.display = 'block';
      setTimeout(() => {
        errorElement.style.display = 'none';
      }, 5000);
    }

    function showSuccess(elementId, message) {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = 'success';
      element.style.display = 'block';
      setTimeout(() => {
        element.style.display = 'none';
      }, 3000);
    }

    function showConnectionError(message) {
      // ì—°ê²° ì—ëŸ¬ í‘œì‹œ
      let errorDiv = document.getElementById('connectionError');
      if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = 'connectionError';
        errorDiv.style.cssText = `
          position: fixed;
          top: 80px;
          left: 50%;
          transform: translateX(-50%);
          background: var(--danger-color);
          color: white;
          padding: 15px 25px;
          border-radius: 10px;
          z-index: 2000;
          box-shadow: var(--shadow-lg);
          animation: slideInRoom 0.3s ease-out;
        `;
        document.body.appendChild(errorDiv);
      }
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    function hideConnectionError() {
      const errorDiv = document.getElementById('connectionError');
      if (errorDiv) {
        errorDiv.style.display = 'none';
      }
    }

    function updateConnectionStatus(status) {
      const statusDiv = document.getElementById('connectionStatus');
      if (!statusDiv) return;
      
      switch (status) {
        case 'connected':
          statusDiv.textContent = 'ğŸŸ¢ ì—°ê²°ë¨';
          statusDiv.style.background = 'var(--success-color)';
          break;
        case 'disconnected':
          statusDiv.textContent = 'ğŸ”´ ì—°ê²° ëŠê¹€';
          statusDiv.style.background = 'var(--danger-color)';
          break;
        case 'error':
          statusDiv.textContent = 'âš ï¸ ì—°ê²° ì˜¤ë¥˜';
          statusDiv.style.background = 'var(--danger-color)';
          break;
        default:
          statusDiv.textContent = 'ğŸŸ¡ ì—°ê²° ì¤‘...';
          statusDiv.style.background = 'var(--warning-color)';
      }
    }

    // ë°© ë‚˜ê°€ê¸° ì²˜ë¦¬ (ë‹¨ìˆœí™”)
    function handleLeaveRoom() {
      console.log('ğŸšª ë°© ë‚˜ê°€ê¸° ì²˜ë¦¬');
      
      // ìƒíƒœ ì´ˆê¸°í™”
      currentRoom = null;
      currentUsername = null;
      currentUserId = null;
      
      // UI ì´ˆê¸°í™”
      const msgInput = document.getElementById('msgInput');
      const sendBtn = document.getElementById('sendBtn');
      const searchToggle = document.querySelector('.search-toggle');
      
      if (msgInput) {
        msgInput.disabled = true;
      msgInput.value = '';
      }
      if (sendBtn) sendBtn.disabled = true;
      if (searchToggle) searchToggle.style.display = 'none';
      
      // ë©”ì‹œì§€ ì˜ì—­ ì´ˆê¸°í™”
      const messagesEl = document.getElementById('messages');
      if (messagesEl) messagesEl.innerHTML = '';
      
      clearTypingIndicator();
      
      // ë°© ì„ íƒ í™”ë©´ìœ¼ë¡œ ì´ë™
      showScreen('roomSelectScreen');
    }

    // ë°© ëª©ë¡ ì—…ë°ì´íŠ¸ (ë‹¨ìˆœí™”)
    function updateRoomsList(rooms) {
      const roomsList = document.getElementById('roomsList');
      if (!roomsList) return;
      
      if (rooms.length === 0) {
        roomsList.innerHTML = `
          <div class="empty-rooms">
            <div class="icon">ğŸ’¬</div>
            <h3>ì•„ì§ ìƒì„±ëœ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ì•„ë˜ì—ì„œ ìƒˆë¡œìš´ ë°©ì„ ë§Œë“¤ì–´ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
          </div>
        `;
        return;
      }

      roomsList.innerHTML = rooms.map(room => `
        <div class="room-item" onclick="selectRoom('${room.id}')">
          <div class="room-info">
            <h3>ğŸ’¬ ${escapeHtml(room.name)}</h3>
            <p>ğŸ“… ìƒì„±ì¼: ${new Date(room.created_at * 1000).toLocaleString()}</p>
          </div>
          <div class="user-count">${room.user_count}ëª…</div>
        </div>
      `).join('');
    }

    // ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸ (ë‹¨ìˆœí™”)
    function updateUserList(users) {
      const userList = document.getElementById('userList');
      const userCount = document.getElementById('userCount');
      
      if (!userList || !userCount) return;
      
      userCount.textContent = users.length;
      
      userList.innerHTML = users.map(user => `
        <div class="user-item" onclick="mentionUser('${escapeHtml(user.username)}')">
          <div class="user-avatar">${getUserInitial(user.username)}</div>
          <div>
            <div class="user-name">${escapeHtml(user.username)}</div>
            <div class="user-status">ì˜¨ë¼ì¸</div>
          </div>
        </div>
      `).join('');
    }

    // ë©”ì‹œì§€ ì¶”ê°€
    function addMessage(data) {
      addMessageToDOM(data, false);
      
      // ë©˜ì…˜ í™•ì¸
      if (data.type === 'user' && data.content.includes(`@${currentUsername}`)) {
        const messagesContainer = document.getElementById('messages');
        const lastMessage = messagesContainer.lastElementChild;
        if (lastMessage) {
          lastMessage.classList.add('mention');
        }
      }
      
      scrollToBottom();
    }

    function addMessageToDOM(data, prepend = false) {
      const messages = document.getElementById('messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${data.type}`;
      messageDiv.dataset.messageId = data.id;
      
      // ìì‹ ì˜ ë©”ì‹œì§€ì¸ì§€ í™•ì¸
      if (data.type === 'user' && data.user_id === currentUserId) {
        messageDiv.classList.add('own');
      }
      
      let timestamp;
      if (data.timestamp) {
        if (data.timestamp.includes('T')) {
          // ISO í˜•ì‹
          timestamp = new Date(data.timestamp).toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit'
          });
        } else {
          // íƒ€ì„ìŠ¤íƒ¬í”„
          timestamp = new Date(data.timestamp * 1000).toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit'
          });
        }
      } else {
        timestamp = new Date().toLocaleTimeString('ko-KR', {
          hour: '2-digit',
          minute: '2-digit'
        });
      }
      
      let headerContent = '';
      if (data.type === 'user') {
        headerContent = `
          <span class="message-username">${escapeHtml(data.username)}</span>
          <span class="message-timestamp">${timestamp}</span>
        `;
      } else if (data.type === 'system') {
        headerContent = `<span class="message-timestamp">${timestamp}</span>`;
      }
      
      // ë©˜ì…˜ ì²˜ë¦¬
      let processedContent = escapeHtml(data.content);
      if (data.type === 'user') {
        processedContent = processedContent.replace(/@(\w+)/g, '<span style="color: var(--mention-color); font-weight: bold;">@$1</span>');
      }
      
      let actionsHTML = '';
      if (data.type === 'user' && data.id) {
        actionsHTML = `
          <div class="message-actions">
            <button class="reaction-btn" onclick="openReactionModal(${data.id})" title="ë°˜ì‘">ğŸ‘</button>
          </div>
        `;
      }
      
      messageDiv.innerHTML = `
        <div class="message-header">${headerContent}</div>
        <div class="message-content">${processedContent}</div>
        <div class="message-reactions" id="reactions-${data.id}"></div>
        ${actionsHTML}
      `;
      
      if (prepend && messages.children.length > 1) {
        // ë¡œë“œ ëª¨ì–´ ë²„íŠ¼ ë‹¤ìŒì— ì‚½ì…
        messages.insertBefore(messageDiv, messages.children[1]);
      } else {
        messages.appendChild(messageDiv);
      }
      
      // ì²« ë²ˆì§¸ ë©”ì‹œì§€ê°€ ì•„ë‹ˆë¼ë©´ ë” ë³´ê¸° ë²„íŠ¼ í‘œì‹œ
      if (messages.children.length > 1) {
        document.getElementById('loadMoreBtn').style.display = 'block';
      }
    }

    // ë©”ì‹œì§€ ë°˜ì‘ ì—…ë°ì´íŠ¸
    function updateMessageReactions(messageId, reactions) {
      const reactionsContainer = document.getElementById(`reactions-${messageId}`);
      if (!reactionsContainer) return;
      
      if (Object.keys(reactions).length === 0) {
        reactionsContainer.innerHTML = '';
        return;
      }
      
      reactionsContainer.innerHTML = Object.entries(reactions).map(([reaction, count]) => `
        <div class="reaction" onclick="toggleReaction(${messageId}, '${reaction}')">
          <span>${reaction}</span>
          <span>${count}</span>
        </div>
      `).join('');
    }

    // íƒ€ì´í•‘ í‘œì‹œ ì—…ë°ì´íŠ¸
    function updateTypingIndicator(typingUsers) {
      const indicator = document.getElementById('typingIndicator');
      const typingText = document.getElementById('typingText');
      
      if (!indicator || !typingText) return;
      
      // ìì‹ ì€ ì œì™¸
      const otherTypingUsers = typingUsers.filter(user => user !== currentUsername);
      
      if (otherTypingUsers.length === 0) {
        indicator.classList.add('hidden');
        return;
      }
      
      let newText = '';
      if (otherTypingUsers.length === 1) {
        newText = `${otherTypingUsers[0]}ë‹˜ì´ ì…ë ¥ ì¤‘`;
      } else if (otherTypingUsers.length === 2) {
        newText = `${otherTypingUsers[0]}ë‹˜ê³¼ ${otherTypingUsers[1]}ë‹˜ì´ ì…ë ¥ ì¤‘`;
      } else {
        newText = `${otherTypingUsers[0]}ë‹˜ ì™¸ ${otherTypingUsers.length - 1}ëª…ì´ ì…ë ¥ ì¤‘`;
      }
      
      typingText.textContent = newText;
      indicator.classList.remove('hidden');
    }

    function clearTypingIndicator() {
      document.getElementById('typingIndicator').classList.add('hidden');
    }

    // ë°© ì„ íƒ
    function selectRoom(roomId) {
      try {
        if (!roomId || roomId.trim() === '') {
          showError('createRoomError', 'ìœ íš¨í•˜ì§€ ì•Šì€ ë°© ì´ë¦„ì…ë‹ˆë‹¤.');
          return;
        }
        
        currentRoom = roomId;
        document.getElementById('selectedRoomName').textContent = roomId;
        showScreen('nameInputScreen');
        document.getElementById('nameInput').focus();
        
        // ì´ì „ ì—ëŸ¬ ë©”ì‹œì§€ ì´ˆê¸°í™”
        document.getElementById('joinError').style.display = 'none';
      } catch (error) {
        console.error('âŒ ë°© ì„ íƒ ì—ëŸ¬:', error);
        showError('createRoomError', 'ë°© ì„ íƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ë°© ìƒì„±
    function createRoom() {
      try {
        const roomName = document.getElementById('newRoomInput').value.trim();
        console.log('ğŸ  ë°© ìƒì„± ì‹œë„:', { roomName, connected: socket?.connected });
        
        if (!roomName) {
          showError('createRoomError', 'ë°© ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        if (!socket || !socket.connected) {
          showError('createRoomError', 'ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        console.log('ğŸ  ë°© ìƒì„± ìš”ì²­ ì „ì†¡:', roomName);
        socket.emit('create_room', { room_id: roomName });
        
        // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ ìš”ì²­ ë°©ì§€)
        const btn = event?.target || document.querySelector('button[type="submit"]');
        if (btn) {
          btn.disabled = true;
          btn.textContent = 'ìƒì„± ì¤‘...';
          setTimeout(() => {
            btn.disabled = false;
            btn.textContent = 'ğŸ  ë§Œë“¤ê¸°!';
          }, 2000);
        }
      } catch (error) {
        console.error('âŒ ë°© ìƒì„± ì—ëŸ¬:', error);
        showError('createRoomError', 'ë°© ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ë°© ì…ì¥
    function joinRoom() {
      try {
        const username = document.getElementById('nameInput').value.trim();
        console.log('ğŸš€ ë°© ì…ì¥ ì‹œë„:', { 
          room: currentRoom, 
          username: username, 
          connected: socket?.connected,
          currentState: { currentRoom, currentUsername, currentUserId }
        });
        
        if (!username) {
          showError('joinError', 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        if (!currentRoom) {
          showError('joinError', 'ì„ íƒëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        if (!socket || !socket.connected) {
          showError('joinError', 'ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        console.log('ğŸš€ ë°© ì…ì¥ ìš”ì²­ ì „ì†¡:', { room: currentRoom, username: username });
        socket.emit('join', { room: currentRoom, username: username });
        
        // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ ìš”ì²­ ë°©ì§€)
        const btn = event?.target || document.querySelector('button[type="submit"]');
        if (btn) {
          btn.disabled = true;
          btn.textContent = 'ì…ì¥ ì¤‘...';
          setTimeout(() => {
            btn.disabled = false;
            btn.textContent = 'ğŸ“ ë“¤ì–´ê°€ê¸°!';
          }, 3000);
        }
      } catch (error) {
        console.error('âŒ ë°© ì…ì¥ ì—ëŸ¬:', error);
        showError('joinError', 'ë°© ì…ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ë°© ë‚˜ê°€ê¸°
    function leaveRoom() {
      console.log('ğŸšª ë°© ë‚˜ê°€ê¸° ë²„íŠ¼ í´ë¦­');
      
      if (socket && socket.connected && currentRoom) {
        // ì„œë²„ì— ë°© ë‚˜ê°€ê¸° ìš”ì²­
        socket.emit('leave');
      } else {
        // ì—°ê²°ì´ ëŠì–´ì§„ ê²½ìš° ì§ì ‘ ì²˜ë¦¬
        handleLeaveRoom();
      }
    }

    // ë©”ì‹œì§€ ì „ì†¡
    function sendMessage() {
      const msgInput = document.getElementById('msgInput');
      const message = msgInput.value.trim();
      if (!message || !currentRoom || !currentUsername) return;

      socket.emit('message', {
        room: currentRoom,
        username: currentUsername,
        msg: message
      });
      
      msgInput.value = '';
      autoResizeTextarea({ target: msgInput });
      updateCharCounter('msgInput', 'msgCharCounter', 500);
      
      // íƒ€ì´í•‘ ìƒíƒœ ì¤‘ì§€
      if (isTyping) {
        socket.emit('typing_stop', {});
        isTyping = false;
      }
    }

    // ê²€ìƒ‰ ê¸°ëŠ¥
    function toggleSearchPanel() {
      const panel = document.getElementById('searchPanel');
      panel.classList.toggle('active');
      
      if (panel.classList.contains('active')) {
        document.getElementById('searchInput').focus();
      }
    }

    function searchMessages() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) {
        showError('searchResults', 'ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (!currentRoom) return;
      
      socket.emit('search_messages_event', { query: query });
    }

    function displaySearchResults(results, query) {
      const container = document.getElementById('searchResults');
      
      if (results.length === 0) {
        container.innerHTML = `
          <p style="text-align: center; color: var(--text-muted); padding: 40px;">
            "${query}" ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
          </p>
        `;
        return;
      }
      
      container.innerHTML = `
        <h4 style="margin-bottom: 15px;">"${query}" ê²€ìƒ‰ ê²°ê³¼ (${results.length}ê°œ)</h4>
        ${results.map(msg => `
          <div class="search-result-item">
            <div class="search-result-content">
              ${highlightSearchTerm(escapeHtml(msg.content), query)}
            </div>
            <div class="search-result-meta">
              ${msg.username} â€¢ ${new Date(msg.timestamp).toLocaleString()}
            </div>
          </div>
        `).join('')}
      `;
    }

    function highlightSearchTerm(text, term) {
      const regex = new RegExp(`(${term})`, 'gi');
      return text.replace(regex, '<span class="search-highlight">$1</span>');
    }

    // ë” ë§ì€ ë©”ì‹œì§€ ë¡œë“œ
    function loadMoreMessages() {
      if (!currentRoom) return;
      
      socket.emit('load_more_messages', {
        offset: messageOffset,
        limit: 20
      });
    }

    // ë°˜ì‘ ê¸°ëŠ¥
    function openReactionModal(messageId) {
      selectedReactionMessageId = messageId;
      document.getElementById('reactionModal').classList.add('active');
    }

    function closeReactionModal() {
      document.getElementById('reactionModal').classList.remove('active');
      selectedReactionMessageId = null;
    }

    function addReaction(reaction) {
      if (!selectedReactionMessageId) return;
      
      socket.emit('add_reaction', {
        message_id: selectedReactionMessageId,
        reaction: reaction
      });
      
      closeReactionModal();
    }

    function toggleReaction(messageId, reaction) {
      socket.emit('add_reaction', {
        message_id: messageId,
        reaction: reaction
      });
    }

    // ë©˜ì…˜ ê¸°ëŠ¥
    function mentionUser(username) {
      const msgInput = document.getElementById('msgInput');
      const currentText = msgInput.value;
      
      if (currentText.trim() === '') {
        msgInput.value = `@${username} `;
      } else {
        msgInput.value = `${currentText} @${username} `;
      }
      
      msgInput.focus();
      autoResizeTextarea({ target: msgInput });
      updateCharCounter('msgInput', 'msgCharCounter', 500);
    }

    function showMentionDropdown() {
      const dropdown = document.getElementById('mentionDropdown');
      dropdown.classList.add('show');
      
      dropdown.innerHTML = allUsers.map((user, index) => `
        <div class="mention-item ${index === 0 ? 'selected' : ''}" onclick="selectMention('${escapeHtml(user.username)}')">
          <div class="mention-avatar">${getUserInitial(user.username)}</div>
          <span>${escapeHtml(user.username)}</span>
        </div>
      `).join('');
      
      mentionIndex = 0;
      filteredUsers = allUsers;
    }

    function selectMention(username) {
      const msgInput = document.getElementById('msgInput');
      const currentText = msgInput.value;
      const atIndex = currentText.lastIndexOf('@');
      
      if (atIndex !== -1) {
        const beforeAt = currentText.substring(0, atIndex);
        msgInput.value = `${beforeAt}@${username} `;
      } else {
        msgInput.value = `${currentText}@${username} `;
      }
      
      document.getElementById('mentionDropdown').classList.remove('show');
      msgInput.focus();
      updateCharCounter('msgInput', 'msgCharCounter', 500);
    }

    function showMentionNotification(data) {
      // ê°„ë‹¨í•œ ì•Œë¦¼ (ì‹¤ì œë¡œëŠ” ë¸Œë¼ìš°ì € ì•Œë¦¼ API ì‚¬ìš© ê°€ëŠ¥)
      playNotificationSound();
      
      // ì„ì‹œ ì•Œë¦¼ í‘œì‹œ
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--primary-color);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: var(--shadow-lg);
        z-index: 1000;
        animation: slideInRoom 0.3s ease-out;
      `;
      notification.innerHTML = `
        <strong>${data.from_user}ë‹˜ì´ ë©˜ì…˜í–ˆìŠµë‹ˆë‹¤</strong><br>
        <small>${data.message.substring(0, 50)}...</small>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 5000);
    }

    // ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ìˆ˜ë™)
    function refreshRooms() {
      console.log('ğŸ”„ ìˆ˜ë™ ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨');
      if (socket && socket.connected) {
        socket.emit('get_rooms');
      }
    }

    // ë’¤ë¡œê°€ê¸°
    function backToRoomSelect() {
      console.log('â¬…ï¸ ë’¤ë¡œê°€ê¸° ë²„íŠ¼ í´ë¦­');
      currentRoom = null;
      showScreen('roomSelectScreen');
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    function setupEventListeners() {
      // ë©”ì‹œì§€ ì…ë ¥ì—ì„œë§Œ ì—”í„°í‚¤ ì²˜ë¦¬ (form ì œì¶œê³¼ ë³„ë„)
      document.getElementById('msgInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchMessages();
      });

      // íƒ€ì´í•‘ ê°ì§€
      document.getElementById('msgInput').addEventListener('input', handleTyping);

      // ë¬¸ì ìˆ˜ ì¹´ìš´í„°
      document.getElementById('newRoomInput').addEventListener('input', (e) => {
        updateCharCounter('newRoomInput', 'roomCharCounter', 30);
      });

      document.getElementById('nameInput').addEventListener('input', (e) => {
        updateCharCounter('nameInput', 'nameCharCounter', 20);
      });

      document.getElementById('msgInput').addEventListener('input', (e) => {
        updateCharCounter('msgInput', 'msgCharCounter', 500);
        handleMentionInput(e);
      });

      // í´ë¦­ ì™¸ë¶€ ê°ì§€
      document.addEventListener('click', (e) => {
        const emojiPicker = document.getElementById('emojiPicker');
        const emojiBtn = document.querySelector('.emoji-btn');
        const mentionDropdown = document.getElementById('mentionDropdown');
        const mentionBtn = document.querySelector('.mention-btn');
        
        if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
          emojiPicker.classList.remove('show');
        }
        
        if (!mentionDropdown.contains(e.target) && e.target !== mentionBtn) {
          mentionDropdown.classList.remove('show');
        }
      });

      // ëª¨ë‹¬ ë‹«ê¸°
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeReactionModal();
          document.getElementById('searchPanel').classList.remove('active');
        }
      });
    }

    // ë©˜ì…˜ ì…ë ¥ ì²˜ë¦¬
    function handleMentionInput(e) {
      const input = e.target;
      const text = input.value;
      const cursorPosition = input.selectionStart;
      
      // @ ë’¤ì˜ í…ìŠ¤íŠ¸ ì°¾ê¸°
      const beforeCursor = text.substring(0, cursorPosition);
      const atIndex = beforeCursor.lastIndexOf('@');
      
      if (atIndex !== -1) {
        const afterAt = beforeCursor.substring(atIndex + 1);
        
        if (afterAt.includes(' ')) {
          document.getElementById('mentionDropdown').classList.remove('show');
          return;
        }
        
        // ì‚¬ìš©ì í•„í„°ë§
        filteredUsers = allUsers.filter(user => 
          user.username.toLowerCase().includes(afterAt.toLowerCase())
        );
        
        if (filteredUsers.length > 0) {
          const dropdown = document.getElementById('mentionDropdown');
          dropdown.innerHTML = filteredUsers.map((user, index) => `
            <div class="mention-item ${index === 0 ? 'selected' : ''}" onclick="selectMention('${escapeHtml(user.username)}')">
              <div class="mention-avatar">${getUserInitial(user.username)}</div>
              <span>${escapeHtml(user.username)}</span>
            </div>
          `).join('');
          dropdown.classList.add('show');
          mentionIndex = 0;
        } else {
          document.getElementById('mentionDropdown').classList.remove('show');
        }
      } else {
        document.getElementById('mentionDropdown').classList.remove('show');
      }
    }

    // íƒ€ì´í•‘ ì²˜ë¦¬
    function handleTyping() {
      if (!isTyping && currentRoom) {
        isTyping = true;
        socket.emit('typing_start', {});
      }

      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => {
        if (isTyping && currentRoom) {
          isTyping = false;
          socket.emit('typing_stop', {});
        }
      }, 1000);
    }

    // í…ìŠ¤íŠ¸ ì˜ì—­ ìë™ í¬ê¸° ì¡°ì •
    function autoResizeTextarea(event) {
      const textarea = event.target;
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    // ë¬¸ì ìˆ˜ ì¹´ìš´í„° ì—…ë°ì´íŠ¸
    function updateCharCounter(inputId, counterId, maxLength) {
      const input = document.getElementById(inputId);
      const counter = document.getElementById(counterId);
      const length = input.value.length;
      
      counter.textContent = `${length}/${maxLength}`;
      
      counter.classList.remove('warning', 'danger');
      if (length > maxLength * 0.8) {
        counter.classList.add('warning');
      }
      if (length > maxLength * 0.95) {
        counter.classList.add('danger');
      }
    }

    // ì´ëª¨ì§€ í”¼ì»¤ ì´ˆê¸°í™”
    function initializeEmojiPicker() {
      const emojiPicker = document.getElementById('emojiPicker');
      
      emojis.forEach(emoji => {
        const button = document.createElement('button');
        button.className = 'emoji-item';
        button.textContent = emoji;
        button.onclick = () => insertEmoji(emoji);
        emojiPicker.appendChild(button);
      });
    }

    // ì´ëª¨ì§€ í”¼ì»¤ í† ê¸€
    function toggleEmojiPicker() {
      const emojiPicker = document.getElementById('emojiPicker');
      emojiPicker.classList.toggle('show');
    }

    // ì´ëª¨ì§€ ì‚½ì…
    function insertEmoji(emoji) {
      const msgInput = document.getElementById('msgInput');
      const start = msgInput.selectionStart;
      const end = msgInput.selectionEnd;
      const text = msgInput.value;
      
      msgInput.value = text.substring(0, start) + emoji + text.substring(end);
      msgInput.selectionStart = msgInput.selectionEnd = start + emoji.length;
      
      updateCharCounter('msgInput', 'msgCharCounter', 500);
      autoResizeTextarea({ target: msgInput });
      msgInput.focus();
      
      document.getElementById('emojiPicker').classList.remove('show');
    }

    // í…Œë§ˆ í† ê¸€
    function toggleTheme() {
      const body = document.body;
      const currentTheme = body.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      const themeBtn = document.querySelector('.theme-toggle');
      themeBtn.textContent = newTheme === 'dark' ? 'â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ' : 'ğŸŒ™ ë‹¤í¬ëª¨ë“œ';
    }

    // í…Œë§ˆ ë¡œë“œ
    function loadTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.body.setAttribute('data-theme', savedTheme);
      
      const themeBtn = document.querySelector('.theme-toggle');
      themeBtn.textContent = savedTheme === 'dark' ? 'â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ' : 'ğŸŒ™ ë‹¤í¬ëª¨ë“œ';
    }

    // ì•Œë¦¼ ì‚¬ìš´ë“œ ì¬ìƒ
    function playNotificationSound() {
      try {
        const audio = document.getElementById('notificationSound');
        audio.currentTime = 0;
        audio.play().catch(e => console.log('ğŸ”‡ Sound play failed:', e));
      } catch (e) {
        console.log('ğŸ”‡ Sound play failed:', e);
      }
    }

    // ìŠ¤í¬ë¡¤ ê´€ë ¨
    function scrollToBottom() {
      const messages = document.getElementById('messages');
      messages.scrollTop = messages.scrollHeight;
    }

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getUserInitial(username) {
      return username.charAt(0).toUpperCase();
    }
  </script>
</body>
</html>