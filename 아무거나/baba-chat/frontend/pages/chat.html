<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ’¬ ì±„íŒ… - BABA CHAT</title>
  <link rel="stylesheet" href="../static/css/style.css">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ’¬ BABA CHAT</h1>
      <div class="header-controls">
        <div id="connectionStatus" style="background: var(--warning-color); color: var(--text-color); padding: 8px 12px; border-radius: 4px; border: 2px solid var(--text-color); font-size: 13px; font-family: inherit; font-weight: bold; margin-right: 15px;">ì—°ê²° ì¤‘...</div>
        <button class="search-toggle" onclick="toggleSearchPanel()">ğŸ” ê²€ìƒ‰</button>
        <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™ ë‹¤í¬ëª¨ë“œ</button>
      </div>
    </div>

    <!-- ê²€ìƒ‰ íŒ¨ë„ -->
    <div class="search-panel" id="searchPanel">
      <div class="search-header">
        <div class="search-input-group">
          <input type="text" class="search-input" id="searchInput" placeholder="ë©”ì‹œì§€ ê²€ìƒ‰...">
          <button class="search-btn" onclick="searchMessages()">ê²€ìƒ‰</button>
        </div>
        <button onclick="toggleSearchPanel()" style="background: var(--text-muted); padding: 8px 15px; border-radius: 15px;">ë‹«ê¸°</button>
      </div>
      <div class="search-results" id="searchResults">
        <p style="text-align: center; color: var(--text-muted); padding: 40px;">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì—¬ ë©”ì‹œì§€ë¥¼ ì°¾ì•„ë³´ì„¸ìš”</p>
      </div>
    </div>

    <div class="main-content">
      <div class="chat-layout">
        <div class="chat-main">
          <div class="chat-header">
            <div class="chat-info">
              <h3 id="currentRoomName"></h3>
              <p>ğŸ‘¤ <span id="currentUserName"></span></p>
            </div>
            <button class="btn-danger" onclick="leaveRoom()">ğŸ‘‹ ë‚˜ê°€ê¸°</button>
          </div>
          
          <div class="chat-messages" id="messages">
            <button class="load-more-btn" id="loadMoreBtn" onclick="loadMoreMessages()" style="display: none;">
              ğŸ“œ ì´ì „ ë©”ì‹œì§€ ë” ë³´ê¸°
            </button>
          </div>
          
          <div class="typing-indicator hidden" id="typingIndicator">
            <span id="typingText"></span>
            <div class="typing-dots">
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
            </div>
          </div>
          
          <form class="message-input-area" onsubmit="event.preventDefault(); sendMessage(); return false;">
            <div class="input-wrapper">
              <textarea id="msgInput" placeholder="ì—¬ê¸°ì— ë©”ì‹œì§€ ì…ë ¥í•˜ì„¸ìš”~ (ìµœëŒ€ 500ì)" 
                       rows="1" maxlength="500"></textarea>
              <div class="input-actions">
                <button type="button" class="mention-btn" onclick="showMentionDropdown()" title="ë©˜ì…˜">@</button>
                <button type="button" class="emoji-btn" onclick="toggleEmojiPicker()" title="ì´ëª¨ì§€">ğŸ˜€</button>
              </div>
              <div class="char-counter" id="msgCharCounter">0/500</div>
              <div class="emoji-picker" id="emojiPicker"></div>
              <div class="mention-dropdown" id="mentionDropdown"></div>
            </div>
            <button type="submit" id="sendBtn">ğŸ’Œ</button>
          </form>
        </div>
        
        <div class="user-list-panel">
          <div class="user-list-header">
            <span class="online-indicator"></span>
            ì˜¨ë¼ì¸ (<span id="userCount">0</span>)
          </div>
          <div id="userList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ë°˜ì‘ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="reactionModal">
    <div class="modal">
      <button class="modal-close" onclick="closeReactionModal()">Ã—</button>
      <h3>ë°˜ì‘ ì„ íƒ</h3>
      <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-top: 20px;">
        <button class="emoji-item" onclick="addReaction('ğŸ‘')">ğŸ‘</button>
        <button class="emoji-item" onclick="addReaction('â¤ï¸')">â¤ï¸</button>
        <button class="emoji-item" onclick="addReaction('ğŸ˜‚')">ğŸ˜‚</button>
        <button class="emoji-item" onclick="addReaction('ğŸ˜®')">ğŸ˜®</button>
        <button class="emoji-item" onclick="addReaction('ğŸ˜¢')">ğŸ˜¢</button>
        <button class="emoji-item" onclick="addReaction('ğŸ˜¡')">ğŸ˜¡</button>
        <button class="emoji-item" onclick="addReaction('ğŸ‰')">ğŸ‰</button>
        <button class="emoji-item" onclick="addReaction('ğŸ”¥')">ğŸ”¥</button>
        <button class="emoji-item" onclick="addReaction('ğŸ’¯')">ğŸ’¯</button>
        <button class="emoji-item" onclick="addReaction('âœ¨')">âœ¨</button>
        <button class="emoji-item" onclick="addReaction('âš¡')">âš¡</button>
        <button class="emoji-item" onclick="addReaction('ğŸš€')">ğŸš€</button>
      </div>
    </div>
  </div>

  <!-- ì˜¤ë””ì˜¤ ì•Œë¦¼ -->
  <audio id="notificationSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmRKBCZ+yO/fjUELEF2779mqWBUJQJvZ8LhmHwU7k9n1s2oXrBkieiTL7YvWDRBfru7cfjBdOABHVhDGDoCsZRQNStLznWElBSGB0fDNeSsFJIHO8diKOQcZZrrr4J5NEAxPquPwtGQeBzt9z/HOeSsFJYLN8deJOAgYZLjq5J9OEwxOoOXgujZgdQ2Q0n5sHAVFs4DyiGQNA6XG9faNTW0QAWB82Q+j7Z+Qjf/PQcOJQg0PU6vj5vgqCj6SzfONdysNJ3bG8N2POAoUYqjv3qtWFAxFnuLgmnXO9QdP5sxpHTMg9QdS68JoHTSJyfSFSSIKPHjI8diONglxe6b0vQ==" type="audio/wav">
  </audio>

  <script>
    let socket;
    let currentRoom = null;
    let currentUsername = null;
    let currentUserId = null;
    let typingTimer = null;
    let isTyping = false;
    let soundEnabled = true;
    let messageOffset = 0;
    let selectedReactionMessageId = null;
    let allUsers = [];
    let mentionIndex = -1;
    let filteredUsers = [];

    // ì´ëª¨ì§€ ëª©ë¡
    const emojis = [
      'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£',
      'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°',
      'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ',
      'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜',
      'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£',
      'ğŸ˜–', 'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ',
      'ğŸ˜¡', 'ğŸ¤¬', 'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨',
      'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜“', 'ğŸ¤—', 'ğŸ¤”', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤¥',
      'ğŸ‘‹', 'ğŸ¤š', 'ğŸ–', 'âœ‹', 'ğŸ––', 'ğŸ‘Œ', 'ğŸ¤Œ', 'ğŸ¤',
      'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†',
      'ğŸ‘‡', 'â˜ï¸', 'ğŸ‘', 'ğŸ‘', 'ğŸ‘Š', 'âœŠ', 'ğŸ¤›', 'ğŸ¤œ',
      'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™', 'ğŸ’ª', 'ğŸ¦¾',
      'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ¤', 'ğŸ–¤',
      'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’–', 'ğŸ’—', 'ğŸ’˜', 'ğŸ’',
      'ğŸ’', 'ğŸ’Ÿ', 'ğŸ”¥', 'âœ¨', 'ğŸ’«', 'â­', 'ğŸŒŸ', 'ğŸ’¥',
      'ğŸ’¯', 'ğŸ’¢', 'ğŸ’¨', 'ğŸ’¦', 'ğŸ’¤', 'ğŸ‰', 'ğŸŠ', 'ğŸˆ',
      'ğŸ', 'ğŸ€', 'ğŸ‚', 'ğŸ„', 'ğŸ†', 'ğŸ‡', 'ğŸ§¨', 'âœ¨',
      'ğŸƒ', 'ğŸ—ï¸', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ†', 'ğŸ“¢', 'âš¡',
      'ğŸ””', 'ğŸ”•', 'ğŸµ', 'ğŸ¶', 'ğŸ’¬', 'ğŸ’­', 'ğŸ—¯ï¸', 'ğŸ’¡',
      'ğŸš€', 'ğŸ›¸', 'ğŸŒ', 'ğŸŒ', 'ğŸŒ', 'ğŸŒ•', 'ğŸŒ–', 'ğŸŒ—'
    ];

    // ============================================================================
    // ğŸ—„ï¸ localStorage ìƒíƒœ ê´€ë¦¬
    // ============================================================================
    
    const AppState = {
      // í˜„ì¬ í˜ì´ì§€ ìƒíƒœ ì €ì¥
      setCurrentPage: (page) => {
        localStorage.setItem('baba_chat_current_page', page);
        localStorage.setItem('baba_chat_last_visit', new Date().toISOString());
      },
      
      // í˜„ì¬ ì±„íŒ… ìƒíƒœ ì €ì¥
      setChatState: (room, username) => {
        const chatState = {
          room: room,
          username: username,
          timestamp: new Date().toISOString()
        };
        localStorage.setItem('baba_chat_current_chat', JSON.stringify(chatState));
      },
      
      // ì±„íŒ… ìƒíƒœ ì¡°íšŒ
      getChatState: () => {
        const data = localStorage.getItem('baba_chat_current_chat');
        return data ? JSON.parse(data) : null;
      },
      
      // ì±„íŒ… ìƒíƒœ ì‚­ì œ (ë°© ë‚˜ê°€ê¸° ì‹œ)
      clearChatState: () => {
        localStorage.removeItem('baba_chat_current_chat');
      },
      
      // ìµœê·¼ ë°© ëª©ë¡ì— ì¶”ê°€
      addRecentRoom: (roomInfo) => {
        let recent = JSON.parse(localStorage.getItem('baba_chat_recent_rooms') || '[]');
        
        // ì¤‘ë³µ ì œê±°
        recent = recent.filter(r => r.id !== roomInfo.id);
        
        // ìµœì‹ ìˆœìœ¼ë¡œ ì¶”ê°€
        recent.unshift({
          ...roomInfo,
          last_visited: new Date().toISOString()
        });
        
        // ìµœëŒ€ 5ê°œë§Œ ìœ ì§€
        recent = recent.slice(0, 5);
        
        localStorage.setItem('baba_chat_recent_rooms', JSON.stringify(recent));
      },
      
      // ì‚¬ìš©ì ì„¤ì • ì¡°íšŒ
      getSetting: (key, defaultValue = null) => {
        const settings = JSON.parse(localStorage.getItem('baba_chat_settings') || '{}');
        return settings[key] || defaultValue;
      }
    };

    // ============================================================================
    // ğŸ¬ ì´ˆê¸°í™”
    // ============================================================================
    
    document.addEventListener('DOMContentLoaded', () => {
      // URLì—ì„œ ë°© ì´ë¦„ê³¼ ì‚¬ìš©ìëª… ê°€ì ¸ì˜¤ê¸°
      const urlParams = new URLSearchParams(window.location.search);
      currentRoom = urlParams.get('room');
      currentUsername = urlParams.get('username');
      
      if (!currentRoom || !currentUsername) {
        // íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ ë°© ì„ íƒ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        window.location.href = 'rooms.html';
        return;
      }
      
      // UI ì—…ë°ì´íŠ¸
      document.getElementById('currentRoomName').textContent = currentRoom;
      document.getElementById('currentUserName').textContent = currentUsername;
      
      // ìƒíƒœ ê´€ë¦¬
      AppState.setCurrentPage('chat');
      AppState.setChatState(currentRoom, currentUsername);
      AppState.addRecentRoom({
        id: currentRoom,
        name: currentRoom,
        user_count: 0  // ì‹¤ì œ ì‚¬ìš©ì ìˆ˜ëŠ” join í›„ì— ì—…ë°ì´íŠ¸
      });
      
      initializeEmojiPicker();
      connectSocket();
      setupEventListeners();
      loadTheme();
    });

    // Socket.IO ì—°ê²°
    function connectSocket() {
      if (socket) return;
      
      try {
        socket = io('http://localhost:8000', {
          reconnection: true,
          reconnectionDelay: 1000,
          reconnectionAttempts: 5,
          timeout: 20000
        });

        socket.on('connect', () => {
          console.log('ğŸ”— ì„œë²„ì— ì—°ê²°ë¨');
          hideConnectionError();
          updateConnectionStatus('connected');
          currentUserId = socket.id;
          
          // ì„œë²„ì— ë°© ì¬ì…ì¥ ìš”ì²­
          socket.emit('join', { room: currentRoom, username: currentUsername });
        });

        socket.on('connect_error', (error) => {
          console.error('âŒ ì—°ê²° ì‹¤íŒ¨:', error);
          updateConnectionStatus('error');
          showConnectionError('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
        });

        socket.on('disconnect', (reason) => {
          console.log('âŒ ì„œë²„ ì—°ê²° ëŠê¹€:', reason);
          updateConnectionStatus('disconnected');
        });

        socket.on('join_success', (data) => {
          console.log('âœ… ë°© ì¬ì…ì¥ ì„±ê³µ:', data);
          // ì‚¬ìš©ì ëª©ë¡ ìš”ì²­
          socket.emit('get_user_list', { room_id: currentRoom });
        });

        socket.on('message_history', (history) => {
          // íˆìŠ¤í† ë¦¬ ë©”ì‹œì§€ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì¶”ê°€
          history.forEach(msg => addMessageToDOM(msg, false));
          scrollToBottom();
        });

        socket.on('message', (data) => {
          addMessage(data);
          
          // ì•Œë¦¼ ì‚¬ìš´ë“œ ì¬ìƒ (ìì‹ ì˜ ë©”ì‹œì§€ê°€ ì•„ë‹Œ ê²½ìš°)
          if (data.type === 'user' && data.user_id !== currentUserId && soundEnabled) {
            playNotificationSound();
          }
        });

        socket.on('user_list', (users) => {
          allUsers = users;
          updateUserList(users);
        });

        socket.on('typing_status', (data) => {
          updateTypingIndicator(data.users);
        });

        socket.on('search_results', (data) => {
          displaySearchResults(data.results, data.query);
        });

        socket.on('more_messages', (data) => {
          if (data.messages.length > 0) {
            const messagesContainer = document.getElementById('messages');
            const oldScrollHeight = messagesContainer.scrollHeight;
            
            // ë©”ì‹œì§€ë“¤ì„ ë§¨ ìœ„ì— ì¶”ê°€
            data.messages.reverse().forEach(msg => {
              addMessageToDOM(msg, true);
            });
            
            // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ìœ ì§€
            messagesContainer.scrollTop = messagesContainer.scrollHeight - oldScrollHeight;
            messageOffset = data.offset;
          } else {
            document.getElementById('loadMoreBtn').style.display = 'none';
          }
        });

        socket.on('reaction_updated', (data) => {
          updateMessageReactions(data.message_id, data.reactions);
        });

        socket.on('mention_notification', (data) => {
          showMentionNotification(data);
        });

        socket.on('leave_success', () => {
          console.log('âœ… ë°© ë‚˜ê°€ê¸° ì„±ê³µ');
          // ë°© ì„ íƒ í˜ì´ì§€ë¡œ ì´ë™
          window.location.href = 'rooms.html';
        });

        socket.on('error', (message) => {
          console.error('Socket ì—ëŸ¬:', message);
        });

      } catch (error) {
        console.error('âŒ Socket.IO ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        showConnectionError('ì—°ê²° ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸
    function updateUserList(users) {
      const userList = document.getElementById('userList');
      const userCount = document.getElementById('userCount');
      
      if (!userList || !userCount) return;
      
      userCount.textContent = users.length;
      
      userList.innerHTML = users.map(user => `
        <div class="user-item" onclick="mentionUser('${escapeHtml(user.username)}')">
          <div class="user-avatar">${getUserInitial(user.username)}</div>
          <div>
            <div class="user-name">${escapeHtml(user.username)}</div>
            <div class="user-status">ì˜¨ë¼ì¸</div>
          </div>
        </div>
      `).join('');
    }

    // ë©”ì‹œì§€ ì¶”ê°€
    function addMessage(data) {
      addMessageToDOM(data, false);
      
      // ë©˜ì…˜ í™•ì¸
      if (data.type === 'user' && data.content.includes(`@${currentUsername}`)) {
        const messagesContainer = document.getElementById('messages');
        const lastMessage = messagesContainer.lastElementChild;
        if (lastMessage) {
          lastMessage.classList.add('mention');
        }
      }
      
      scrollToBottom();
    }

    function addMessageToDOM(data, prepend = false) {
      const messages = document.getElementById('messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${data.type}`;
      messageDiv.dataset.messageId = data.id;
      
      // ìì‹ ì˜ ë©”ì‹œì§€ì¸ì§€ í™•ì¸
      if (data.type === 'user' && data.user_id === currentUserId) {
        messageDiv.classList.add('own');
      }
      
      let timestamp;
      if (data.timestamp) {
        if (data.timestamp.includes('T')) {
          // ISO í˜•ì‹
          timestamp = new Date(data.timestamp).toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit'
          });
        } else {
          // íƒ€ì„ìŠ¤íƒ¬í”„
          timestamp = new Date(data.timestamp * 1000).toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit'
          });
        }
      } else {
        timestamp = new Date().toLocaleTimeString('ko-KR', {
          hour: '2-digit',
          minute: '2-digit'
        });
      }
      
      let headerContent = '';
      if (data.type === 'user') {
        headerContent = `
          <span class="message-username">${escapeHtml(data.username)}</span>
          <span class="message-timestamp">${timestamp}</span>
        `;
      } else if (data.type === 'system') {
        headerContent = `<span class="message-timestamp">${timestamp}</span>`;
      }
      
      // ë©˜ì…˜ ì²˜ë¦¬
      let processedContent = escapeHtml(data.content);
      if (data.type === 'user') {
        processedContent = processedContent.replace(/@(\w+)/g, '<span style="color: var(--mention-color); font-weight: bold;">@$1</span>');
      }
      
      let actionsHTML = '';
      if (data.type === 'user' && data.id) {
        actionsHTML = `
          <div class="message-actions">
            <button class="reaction-btn" onclick="openReactionModal(${data.id})" title="ë°˜ì‘">ğŸ‘</button>
          </div>
        `;
      }
      
      messageDiv.innerHTML = `
        <div class="message-header">${headerContent}</div>
        <div class="message-content">${processedContent}</div>
        <div class="message-reactions" id="reactions-${data.id}"></div>
        ${actionsHTML}
      `;
      
      if (prepend && messages.children.length > 1) {
        // ë¡œë“œ ëª¨ì–´ ë²„íŠ¼ ë‹¤ìŒì— ì‚½ì…
        messages.insertBefore(messageDiv, messages.children[1]);
      } else {
        messages.appendChild(messageDiv);
      }
      
      // ì²« ë²ˆì§¸ ë©”ì‹œì§€ê°€ ì•„ë‹ˆë¼ë©´ ë” ë³´ê¸° ë²„íŠ¼ í‘œì‹œ
      if (messages.children.length > 1) {
        document.getElementById('loadMoreBtn').style.display = 'block';
      }
    }

    // ë©”ì‹œì§€ ë°˜ì‘ ì—…ë°ì´íŠ¸
    function updateMessageReactions(messageId, reactions) {
      const reactionsContainer = document.getElementById(`reactions-${messageId}`);
      if (!reactionsContainer) return;
      
      if (Object.keys(reactions).length === 0) {
        reactionsContainer.innerHTML = '';
        return;
      }
      
      reactionsContainer.innerHTML = Object.entries(reactions).map(([reaction, count]) => `
        <div class="reaction" onclick="toggleReaction(${messageId}, '${reaction}')">
          <span>${reaction}</span>
          <span>${count}</span>
        </div>
      `).join('');
    }

    // íƒ€ì´í•‘ í‘œì‹œ ì—…ë°ì´íŠ¸
    function updateTypingIndicator(typingUsers) {
      const indicator = document.getElementById('typingIndicator');
      const typingText = document.getElementById('typingText');
      
      if (!indicator || !typingText) return;
      
      // ìì‹ ì€ ì œì™¸
      const otherTypingUsers = typingUsers.filter(user => user !== currentUsername);
      
      if (otherTypingUsers.length === 0) {
        indicator.classList.add('hidden');
        return;
      }
      
      let newText = '';
      if (otherTypingUsers.length === 1) {
        newText = `${otherTypingUsers[0]}ë‹˜ì´ ì…ë ¥ ì¤‘`;
      } else if (otherTypingUsers.length === 2) {
        newText = `${otherTypingUsers[0]}ë‹˜ê³¼ ${otherTypingUsers[1]}ë‹˜ì´ ì…ë ¥ ì¤‘`;
      } else {
        newText = `${otherTypingUsers[0]}ë‹˜ ì™¸ ${otherTypingUsers.length - 1}ëª…ì´ ì…ë ¥ ì¤‘`;
      }
      
      typingText.textContent = newText;
      indicator.classList.remove('hidden');
    }

    function clearTypingIndicator() {
      document.getElementById('typingIndicator').classList.add('hidden');
    }

    // ë°© ë‚˜ê°€ê¸°
    function leaveRoom() {
      console.log('ğŸšª ë°© ë‚˜ê°€ê¸° ë²„íŠ¼ í´ë¦­');
      
      // í˜„ì¬ ì±„íŒ… ìƒíƒœ ì‚­ì œ
      AppState.clearChatState();
      AppState.setCurrentPage('rooms');
      
      if (socket && socket.connected && currentRoom) {
        // ì„œë²„ì— ë°© ë‚˜ê°€ê¸° ìš”ì²­
        socket.emit('leave');
      } else {
        // ì—°ê²°ì´ ëŠì–´ì§„ ê²½ìš° ì§ì ‘ ë°© ì„ íƒ í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = 'rooms.html';
      }
    }

    // ë©”ì‹œì§€ ì „ì†¡
    function sendMessage() {
      const msgInput = document.getElementById('msgInput');
      const message = msgInput.value.trim();
      if (!message || !currentRoom || !currentUsername) return;

      socket.emit('message', {
        room: currentRoom,
        username: currentUsername,
        msg: message
      });
      
      msgInput.value = '';
      autoResizeTextarea({ target: msgInput });
      updateCharCounter('msgInput', 'msgCharCounter', 500);
      
      // íƒ€ì´í•‘ ìƒíƒœ ì¤‘ì§€
      if (isTyping) {
        socket.emit('typing_stop', {});
        isTyping = false;
      }
    }

    // ê²€ìƒ‰ ê¸°ëŠ¥
    function toggleSearchPanel() {
      const panel = document.getElementById('searchPanel');
      panel.classList.toggle('active');
      
      if (panel.classList.contains('active')) {
        document.getElementById('searchInput').focus();
      }
    }

    function searchMessages() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return;
      
      if (!currentRoom) return;
      
      socket.emit('search_messages_event', { query: query });
    }

    function displaySearchResults(results, query) {
      const container = document.getElementById('searchResults');
      
      if (results.length === 0) {
        container.innerHTML = `
          <p style="text-align: center; color: var(--text-muted); padding: 40px;">
            "${query}" ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
          </p>
        `;
        return;
      }
      
      container.innerHTML = `
        <h4 style="margin-bottom: 15px;">"${query}" ê²€ìƒ‰ ê²°ê³¼ (${results.length}ê°œ)</h4>
        ${results.map(msg => `
          <div class="search-result-item">
            <div class="search-result-content">
              ${highlightSearchTerm(escapeHtml(msg.content), query)}
            </div>
            <div class="search-result-meta">
              ${msg.username} â€¢ ${new Date(msg.timestamp).toLocaleString()}
            </div>
          </div>
        `).join('')}
      `;
    }

    function highlightSearchTerm(text, term) {
      const regex = new RegExp(`(${term})`, 'gi');
      return text.replace(regex, '<span class="search-highlight">$1</span>');
    }

    // ë” ë§ì€ ë©”ì‹œì§€ ë¡œë“œ
    function loadMoreMessages() {
      if (!currentRoom) return;
      
      socket.emit('load_more_messages', {
        offset: messageOffset,
        limit: 20
      });
    }

    // ë°˜ì‘ ê¸°ëŠ¥
    function openReactionModal(messageId) {
      selectedReactionMessageId = messageId;
      document.getElementById('reactionModal').classList.add('active');
    }

    function closeReactionModal() {
      document.getElementById('reactionModal').classList.remove('active');
      selectedReactionMessageId = null;
    }

    function addReaction(reaction) {
      if (!selectedReactionMessageId) return;
      
      socket.emit('add_reaction', {
        message_id: selectedReactionMessageId,
        reaction: reaction
      });
      
      closeReactionModal();
    }

    function toggleReaction(messageId, reaction) {
      socket.emit('add_reaction', {
        message_id: messageId,
        reaction: reaction
      });
    }

    // ë©˜ì…˜ ê¸°ëŠ¥
    function mentionUser(username) {
      const msgInput = document.getElementById('msgInput');
      const currentText = msgInput.value;
      
      if (currentText.trim() === '') {
        msgInput.value = `@${username} `;
      } else {
        msgInput.value = `${currentText} @${username} `;
      }
      
      msgInput.focus();
      autoResizeTextarea({ target: msgInput });
      updateCharCounter('msgInput', 'msgCharCounter', 500);
    }

    function showMentionDropdown() {
      const dropdown = document.getElementById('mentionDropdown');
      dropdown.classList.add('show');
      
      dropdown.innerHTML = allUsers.map((user, index) => `
        <div class="mention-item ${index === 0 ? 'selected' : ''}" onclick="selectMention('${escapeHtml(user.username)}')">
          <div class="mention-avatar">${getUserInitial(user.username)}</div>
          <span>${escapeHtml(user.username)}</span>
        </div>
      `).join('');
      
      mentionIndex = 0;
      filteredUsers = allUsers;
    }

    function selectMention(username) {
      const msgInput = document.getElementById('msgInput');
      const currentText = msgInput.value;
      const atIndex = currentText.lastIndexOf('@');
      
      if (atIndex !== -1) {
        const beforeAt = currentText.substring(0, atIndex);
        msgInput.value = `${beforeAt}@${username} `;
      } else {
        msgInput.value = `${currentText}@${username} `;
      }
      
      document.getElementById('mentionDropdown').classList.remove('show');
      msgInput.focus();
      updateCharCounter('msgInput', 'msgCharCounter', 500);
    }

    function showMentionNotification(data) {
      // ê°„ë‹¨í•œ ì•Œë¦¼
      playNotificationSound();
      
      // ì„ì‹œ ì•Œë¦¼ í‘œì‹œ
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--primary-color);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: var(--shadow-lg);
        z-index: 1000;
      `;
      notification.innerHTML = `
        <strong>${data.from_user}ë‹˜ì´ ë©˜ì…˜í–ˆìŠµë‹ˆë‹¤</strong><br>
        <small>${data.message.substring(0, 50)}...</small>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 5000);
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    function setupEventListeners() {
      // ë©”ì‹œì§€ ì…ë ¥ì—ì„œë§Œ ì—”í„°í‚¤ ì²˜ë¦¬ (form ì œì¶œê³¼ ë³„ë„)
      document.getElementById('msgInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchMessages();
      });

      // íƒ€ì´í•‘ ê°ì§€
      document.getElementById('msgInput').addEventListener('input', handleTyping);

      // ë¬¸ì ìˆ˜ ì¹´ìš´í„°
      document.getElementById('msgInput').addEventListener('input', (e) => {
        updateCharCounter('msgInput', 'msgCharCounter', 500);
        handleMentionInput(e);
      });

      // í´ë¦­ ì™¸ë¶€ ê°ì§€
      document.addEventListener('click', (e) => {
        const emojiPicker = document.getElementById('emojiPicker');
        const emojiBtn = document.querySelector('.emoji-btn');
        const mentionDropdown = document.getElementById('mentionDropdown');
        const mentionBtn = document.querySelector('.mention-btn');
        
        if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
          emojiPicker.classList.remove('show');
        }
        
        if (!mentionDropdown.contains(e.target) && e.target !== mentionBtn) {
          mentionDropdown.classList.remove('show');
        }
      });

      // ëª¨ë‹¬ ë‹«ê¸°
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeReactionModal();
          document.getElementById('searchPanel').classList.remove('active');
        }
      });
    }

    // ë©˜ì…˜ ì…ë ¥ ì²˜ë¦¬
    function handleMentionInput(e) {
      const input = e.target;
      const text = input.value;
      const cursorPosition = input.selectionStart;
      
      // @ ë’¤ì˜ í…ìŠ¤íŠ¸ ì°¾ê¸°
      const beforeCursor = text.substring(0, cursorPosition);
      const atIndex = beforeCursor.lastIndexOf('@');
      
      if (atIndex !== -1) {
        const afterAt = beforeCursor.substring(atIndex + 1);
        
        if (afterAt.includes(' ')) {
          document.getElementById('mentionDropdown').classList.remove('show');
          return;
        }
        
        // ì‚¬ìš©ì í•„í„°ë§
        filteredUsers = allUsers.filter(user => 
          user.username.toLowerCase().includes(afterAt.toLowerCase())
        );
        
        if (filteredUsers.length > 0) {
          const dropdown = document.getElementById('mentionDropdown');
          dropdown.innerHTML = filteredUsers.map((user, index) => `
            <div class="mention-item ${index === 0 ? 'selected' : ''}" onclick="selectMention('${escapeHtml(user.username)}')">
              <div class="mention-avatar">${getUserInitial(user.username)}</div>
              <span>${escapeHtml(user.username)}</span>
            </div>
          `).join('');
          dropdown.classList.add('show');
          mentionIndex = 0;
        } else {
          document.getElementById('mentionDropdown').classList.remove('show');
        }
      } else {
        document.getElementById('mentionDropdown').classList.remove('show');
      }
    }

    // íƒ€ì´í•‘ ì²˜ë¦¬
    function handleTyping() {
      if (!isTyping && currentRoom) {
        isTyping = true;
        socket.emit('typing_start', {});
      }

      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => {
        if (isTyping && currentRoom) {
          isTyping = false;
          socket.emit('typing_stop', {});
        }
      }, 1000);
    }

    // í…ìŠ¤íŠ¸ ì˜ì—­ ìë™ í¬ê¸° ì¡°ì •
    function autoResizeTextarea(event) {
      const textarea = event.target;
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    // ë¬¸ì ìˆ˜ ì¹´ìš´í„° ì—…ë°ì´íŠ¸
    function updateCharCounter(inputId, counterId, maxLength) {
      const input = document.getElementById(inputId);
      const counter = document.getElementById(counterId);
      const length = input.value.length;
      
      counter.textContent = `${length}/${maxLength}`;
      
      counter.classList.remove('warning', 'danger');
      if (length > maxLength * 0.8) {
        counter.classList.add('warning');
      }
      if (length > maxLength * 0.95) {
        counter.classList.add('danger');
      }
    }

    // ì´ëª¨ì§€ í”¼ì»¤ ì´ˆê¸°í™”
    function initializeEmojiPicker() {
      const emojiPicker = document.getElementById('emojiPicker');
      
      emojis.forEach(emoji => {
        const button = document.createElement('button');
        button.className = 'emoji-item';
        button.textContent = emoji;
        button.onclick = () => insertEmoji(emoji);
        emojiPicker.appendChild(button);
      });
    }

    // ì´ëª¨ì§€ í”¼ì»¤ í† ê¸€
    function toggleEmojiPicker() {
      const emojiPicker = document.getElementById('emojiPicker');
      emojiPicker.classList.toggle('show');
    }

    // ì´ëª¨ì§€ ì‚½ì…
    function insertEmoji(emoji) {
      const msgInput = document.getElementById('msgInput');
      const start = msgInput.selectionStart;
      const end = msgInput.selectionEnd;
      const text = msgInput.value;
      
      msgInput.value = text.substring(0, start) + emoji + text.substring(end);
      msgInput.selectionStart = msgInput.selectionEnd = start + emoji.length;
      
      updateCharCounter('msgInput', 'msgCharCounter', 500);
      autoResizeTextarea({ target: msgInput });
      msgInput.focus();
      
      document.getElementById('emojiPicker').classList.remove('show');
    }

    // í…Œë§ˆ í† ê¸€
    function toggleTheme() {
      const body = document.body;
      const currentTheme = body.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      const themeBtn = document.querySelector('.theme-toggle');
      themeBtn.textContent = newTheme === 'dark' ? 'â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ' : 'ğŸŒ™ ë‹¤í¬ëª¨ë“œ';
    }

    // í…Œë§ˆ ë¡œë“œ
    function loadTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.body.setAttribute('data-theme', savedTheme);
      
      const themeBtn = document.querySelector('.theme-toggle');
      themeBtn.textContent = savedTheme === 'dark' ? 'â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ' : 'ğŸŒ™ ë‹¤í¬ëª¨ë“œ';
    }

    // ì•Œë¦¼ ì‚¬ìš´ë“œ ì¬ìƒ
    function playNotificationSound() {
      try {
        const audio = document.getElementById('notificationSound');
        audio.currentTime = 0;
        audio.play().catch(e => console.log('ğŸ”‡ Sound play failed:', e));
      } catch (e) {
        console.log('ğŸ”‡ Sound play failed:', e);
      }
    }

    // ìŠ¤í¬ë¡¤ ê´€ë ¨
    function scrollToBottom() {
      const messages = document.getElementById('messages');
      messages.scrollTop = messages.scrollHeight;
    }

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getUserInitial(username) {
      return username.charAt(0).toUpperCase();
    }

    function showConnectionError(message) {
      let errorDiv = document.getElementById('connectionError');
      if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = 'connectionError';
        errorDiv.style.cssText = `
          position: fixed;
          top: 80px;
          left: 50%;
          transform: translateX(-50%);
          background: var(--danger-color);
          color: white;
          padding: 15px 25px;
          border-radius: 10px;
          z-index: 2000;
          box-shadow: var(--shadow-lg);
        `;
        document.body.appendChild(errorDiv);
      }
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    function hideConnectionError() {
      const errorDiv = document.getElementById('connectionError');
      if (errorDiv) {
        errorDiv.style.display = 'none';
      }
    }

    function updateConnectionStatus(status) {
      const statusDiv = document.getElementById('connectionStatus');
      if (!statusDiv) return;
      
      switch (status) {
        case 'connected':
          statusDiv.textContent = 'ğŸŸ¢ ì—°ê²°ë¨';
          statusDiv.style.background = 'var(--success-color)';
          break;
        case 'disconnected':
          statusDiv.textContent = 'ğŸ”´ ì—°ê²° ëŠê¹€';
          statusDiv.style.background = 'var(--danger-color)';
          break;
        case 'error':
          statusDiv.textContent = 'âš ï¸ ì—°ê²° ì˜¤ë¥˜';
          statusDiv.style.background = 'var(--danger-color)';
          break;
        default:
          statusDiv.textContent = 'ğŸŸ¡ ì—°ê²° ì¤‘...';
          statusDiv.style.background = 'var(--warning-color)';
      }
    }
  </script>
</body>
</html>