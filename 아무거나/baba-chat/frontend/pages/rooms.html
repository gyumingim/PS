<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ’¬ ë°© ì„ íƒ - BABA CHAT</title>
  <link rel="stylesheet" href="../static/css/style.css">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ’¬ BABA CHAT</h1>
      <div class="header-controls">
        <div id="connectionStatus" style="background: var(--warning-color); color: var(--text-color); padding: 8px 12px; border-radius: 4px; border: 2px solid var(--text-color); font-size: 13px; font-family: inherit; font-weight: bold; margin-right: 15px;">ì—°ê²° ì¤‘...</div>
        <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™ ë‹¤í¬ëª¨ë“œ</button>
      </div>
    </div>

    <div class="main-content">
      <div class="room-select-screen">
        <div class="welcome-section">
          <h2>HELLO IS YOU!</h2>
        </div>
        
        <div class="controls">
          <button class="refresh-btn" onclick="refreshRooms()">ğŸ”„ ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        
        <div class="room-list">
          <div id="roomsList">
            <div class="empty-rooms">
              <div class="icon">ğŸ </div>
              <h3>ë°©ì´ ì—†ì–´ìš”!</h3>
              <p>ìƒˆë¡œìš´ ë°©ì„ ë§Œë“¤ì–´ì„œ ì¹œêµ¬ë“¤ê³¼ ìˆ˜ë‹¤ ë–¨ì–´ìš”~</p>
            </div>
          </div>
        </div>

        <div class="create-room-form">
          <h3>ğŸ  ìƒˆ ë°© ë§Œë“¤ê¸°</h3>
          <form onsubmit="event.preventDefault(); createRoom(); return false;">
            <div class="form-group">
              <label>ë°© ì´ë¦„ (ìµœëŒ€ 30ì):</label>
              <input type="text" id="newRoomInput" placeholder="ì˜ˆ: ììœ ì±„íŒ…, ê°œë°œí† ë¡ , ê²Œì„ë°© ë“±" maxlength="30">
              <div class="char-counter" id="roomCharCounter">0/30</div>
            </div>
            <button type="submit">ğŸ  ë§Œë“¤ê¸°!</button>
          </form>
          <div id="createRoomError" class="error" style="display: none;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let socket;

    // ì´ˆê¸°í™”
    // ============================================================================
    // ğŸ—„ï¸ localStorage ìƒíƒœ ê´€ë¦¬
    // ============================================================================
    
    const AppState = {
      // í˜„ì¬ í˜ì´ì§€ ìƒíƒœ ì €ì¥
      setCurrentPage: (page) => {
        localStorage.setItem('baba_chat_current_page', page);
        localStorage.setItem('baba_chat_last_visit', new Date().toISOString());
      },
      
      // ë§ˆì§€ë§‰ ë°©ë¬¸ í˜ì´ì§€ ì¡°íšŒ
      getCurrentPage: () => {
        return localStorage.getItem('baba_chat_current_page') || 'rooms';
      },
      
      // ë§ˆì§€ë§‰ ì…ì¥í•œ ë°© ì •ë³´ ì €ì¥
      setLastRoom: (roomInfo) => {
        localStorage.setItem('baba_chat_last_room', JSON.stringify(roomInfo));
      },
      
      // ë§ˆì§€ë§‰ ì…ì¥í•œ ë°© ì •ë³´ ì¡°íšŒ
      getLastRoom: () => {
        const data = localStorage.getItem('baba_chat_last_room');
        return data ? JSON.parse(data) : null;
      },
      
      // ìµœê·¼ ë°© ëª©ë¡ ì €ì¥ (ìµœëŒ€ 5ê°œ)
      addRecentRoom: (roomInfo) => {
        let recent = JSON.parse(localStorage.getItem('baba_chat_recent_rooms') || '[]');
        
        // ì¤‘ë³µ ì œê±°
        recent = recent.filter(r => r.id !== roomInfo.id);
        
        // ìµœì‹ ìˆœìœ¼ë¡œ ì¶”ê°€
        recent.unshift({
          ...roomInfo,
          last_visited: new Date().toISOString()
        });
        
        // ìµœëŒ€ 5ê°œë§Œ ìœ ì§€
        recent = recent.slice(0, 5);
        
        localStorage.setItem('baba_chat_recent_rooms', JSON.stringify(recent));
      },
      
      // ìµœê·¼ ë°© ëª©ë¡ ì¡°íšŒ
      getRecentRooms: () => {
        return JSON.parse(localStorage.getItem('baba_chat_recent_rooms') || '[]');
      },
      
      // ì‚¬ìš©ì ì„¤ì • ì €ì¥
      setSetting: (key, value) => {
        const settings = JSON.parse(localStorage.getItem('baba_chat_settings') || '{}');
        settings[key] = value;
        localStorage.setItem('baba_chat_settings', JSON.stringify(settings));
      },
      
      // ì‚¬ìš©ì ì„¤ì • ì¡°íšŒ
      getSetting: (key, defaultValue = null) => {
        const settings = JSON.parse(localStorage.getItem('baba_chat_settings') || '{}');
        return settings[key] || defaultValue;
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      // í˜„ì¬ í˜ì´ì§€ë¥¼ roomsë¡œ ì„¤ì •
      AppState.setCurrentPage('rooms');
      
      connectSocket();
      setupEventListeners();
      loadTheme();
      showRecentRooms();
    });

    // Socket.IO ì—°ê²°
    function connectSocket() {
      if (socket) return;
      
      try {
        socket = io('http://localhost:8000', {
          reconnection: true,
          reconnectionDelay: 1000,
          reconnectionAttempts: 5,
          timeout: 20000
        });

        socket.on('connect', () => {
          console.log('ğŸ”— ì„œë²„ì— ì—°ê²°ë¨');
          hideConnectionError();
          updateConnectionStatus('connected');
          socket.emit('get_rooms');
        });

        socket.on('connect_error', (error) => {
          console.error('âŒ ì—°ê²° ì‹¤íŒ¨:', error);
          updateConnectionStatus('error');
          showConnectionError('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
        });

        socket.on('disconnect', (reason) => {
          console.log('âŒ ì„œë²„ ì—°ê²° ëŠê¹€:', reason);
          updateConnectionStatus('disconnected');
          if (reason === 'io server disconnect') {
            socket.connect();
          }
        });
      } catch (error) {
        console.error('âŒ Socket.IO ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        showConnectionError('ì—°ê²° ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
      
      socket.on('rooms_list', (rooms) => {
        updateRoomsList(rooms);
      });

      socket.on('room_created', (data) => {
        console.log('ğŸ  ë°© ìƒì„±ë¨:', data.room_id);
        document.getElementById('newRoomInput').value = '';
        updateCharCounter('newRoomInput', 'roomCharCounter', 30);
        showSuccess('createRoomError', 'ë°©ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
      });

      socket.on('error', (message) => {
        showError('createRoomError', message);
      });
    }

    // ë°© ëª©ë¡ ì—…ë°ì´íŠ¸
    function updateRoomsList(rooms) {
      const roomsList = document.getElementById('roomsList');
      if (!roomsList) return;
      
      if (rooms.length === 0) {
        roomsList.innerHTML = `
          <div class="empty-rooms">
            <div class="icon">ğŸ </div>
            <h3>ë°©ì´ ì—†ì–´ìš”!</h3>
            <p>ìƒˆë¡œìš´ ë°©ì„ ë§Œë“¤ì–´ì„œ ì¹œêµ¬ë“¤ê³¼ ìˆ˜ë‹¤ ë–¨ì–´ìš”~</p>
          </div>
        `;
        return;
      }

      roomsList.innerHTML = rooms.map(room => `
        <div class="room-item" onclick="selectRoom('${room.id}')">
          <div class="room-info">
            <h3>ğŸ’¬ ${escapeHtml(room.name)}</h3>
            <p>ğŸ“… ìƒì„±ì¼: ${new Date(room.created_at * 1000).toLocaleString()}</p>
          </div>
          <div class="user-count">${room.user_count}ëª…</div>
        </div>
      `).join('');
    }

    // ë°© ì„ íƒ
    function selectRoom(roomId) {
      if (!roomId || roomId.trim() === '') {
        showError('createRoomError', 'ìœ íš¨í•˜ì§€ ì•Šì€ ë°© ì´ë¦„ì…ë‹ˆë‹¤.');
        return;
      }
      
      // ìµœê·¼ ë°© ëª©ë¡ì— ì¶”ê°€
      const roomInfo = { 
        id: roomId, 
        name: roomId,
        user_count: getCurrentRoomUserCount(roomId)
      };
      AppState.setLastRoom(roomInfo);
      AppState.addRecentRoom(roomInfo);
      
      // ë°© ì´ë¦„ì„ URL íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•˜ë©° ë‹‰ë„¤ì„ ì…ë ¥ í˜ì´ì§€ë¡œ ì´ë™
      window.location.href = `join.html?room=${encodeURIComponent(roomId)}`;
    }
    
    // í˜„ì¬ ë°©ì˜ ì‚¬ìš©ì ìˆ˜ ì¡°íšŒ
    function getCurrentRoomUserCount(roomId) {
      const roomItems = document.querySelectorAll('.room-item:not(.recent-room)');
      for (const item of roomItems) {
        if (item.onclick && item.onclick.toString().includes(roomId)) {
          const userCountElement = item.querySelector('.user-count');
          if (userCountElement) {
            return parseInt(userCountElement.textContent) || 0;
          }
        }
      }
      return 0;
    }

    // ë°© ìƒì„±
    function createRoom() {
      try {
        const roomName = document.getElementById('newRoomInput').value.trim();
        
        if (!roomName) {
          showError('createRoomError', 'ë°© ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        if (!socket || !socket.connected) {
          showError('createRoomError', 'ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        socket.emit('create_room', { room_id: roomName });
        
        // ë²„íŠ¼ ë¹„í™œì„±í™”
        const btn = event?.target || document.querySelector('button[type="submit"]');
        if (btn) {
          btn.disabled = true;
          btn.textContent = 'ìƒì„± ì¤‘...';
          setTimeout(() => {
            btn.disabled = false;
            btn.textContent = 'ğŸ  ë§Œë“¤ê¸°!';
          }, 2000);
        }
      } catch (error) {
        console.error('âŒ ë°© ìƒì„± ì—ëŸ¬:', error);
        showError('createRoomError', 'ë°© ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    function refreshRooms() {
      if (socket && socket.connected) {
        socket.emit('get_rooms');
      }
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    function setupEventListeners() {
      document.getElementById('newRoomInput').addEventListener('input', (e) => {
        updateCharCounter('newRoomInput', 'roomCharCounter', 30);
      });
    }

    // ============================================================================
    // ğŸ•’ ìµœê·¼ ë°© ëª©ë¡ í‘œì‹œ
    // ============================================================================
    
    function showRecentRooms() {
      const recentRooms = AppState.getRecentRooms();
      if (recentRooms.length === 0) return;
      
      const roomsList = document.getElementById('roomsList');
      
      // ìµœê·¼ ë°© ì„¹ì…˜ ìƒì„±
      const recentSection = document.createElement('div');
      recentSection.className = 'recent-rooms-section';
      recentSection.innerHTML = `
        <div class="section-header">
          <h3>ğŸ•’ ìµœê·¼ ë°©ë¬¸í•œ ë°©</h3>
          <button class="clear-recent-btn" onclick="clearRecentRooms()">ì§€ìš°ê¸°</button>
        </div>
        <div class="recent-rooms-list" id="recentRoomsList"></div>
      `;
      
      // ê¸°ì¡´ ë°© ëª©ë¡ ì•ì— ì‚½ì…
      roomsList.insertBefore(recentSection, roomsList.firstChild);
      
      // ìµœê·¼ ë°© ëª©ë¡ ë Œë”ë§
      const recentRoomsList = document.getElementById('recentRoomsList');
      recentRooms.forEach(room => {
        const roomElement = document.createElement('div');
        roomElement.className = 'room-item recent-room';
        roomElement.innerHTML = `
          <div class="room-info">
            <div class="room-name">${room.name || room.id}</div>
            <div class="room-meta">
              <span class="room-time">ë§ˆì§€ë§‰ ë°©ë¬¸: ${formatTime(room.last_visited)}</span>
            </div>
          </div>
          <button class="join-btn" onclick="joinRecentRoom('${room.id}', '${room.name || room.id}')">
            ì…ì¥
          </button>
        `;
        recentRoomsList.appendChild(roomElement);
      });
    }
    
    function clearRecentRooms() {
      if (confirm('ìµœê·¼ ë°©ë¬¸í•œ ë°© ëª©ë¡ì„ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        localStorage.removeItem('baba_chat_recent_rooms');
        location.reload();
      }
    }
    
    function joinRecentRoom(roomId, roomName) {
      const roomInfo = { id: roomId, name: roomName };
      AppState.setLastRoom(roomInfo);
      AppState.addRecentRoom(roomInfo);
      window.location.href = `join.html?room=${encodeURIComponent(roomId)}`;
    }
    
    function formatTime(isoString) {
      const date = new Date(isoString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      if (diffMins < 1) return 'ë°©ê¸ˆ ì „';
      if (diffMins < 60) return `${diffMins}ë¶„ ì „`;
      if (diffHours < 24) return `${diffHours}ì‹œê°„ ì „`;
      if (diffDays < 7) return `${diffDays}ì¼ ì „`;
      return date.toLocaleDateString();
    }

    // ============================================================================
    // ğŸ› ï¸ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    // ============================================================================
    function showError(elementId, message) {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = message;
      errorElement.className = 'error';
      errorElement.style.display = 'block';
      setTimeout(() => {
        errorElement.style.display = 'none';
      }, 5000);
    }

    function showSuccess(elementId, message) {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = 'success';
      element.style.display = 'block';
      setTimeout(() => {
        element.style.display = 'none';
      }, 3000);
    }

    function showConnectionError(message) {
      let errorDiv = document.getElementById('connectionError');
      if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = 'connectionError';
        errorDiv.style.cssText = `
          position: fixed;
          top: 80px;
          left: 50%;
          transform: translateX(-50%);
          background: var(--danger-color);
          color: white;
          padding: 15px 25px;
          border-radius: 10px;
          z-index: 2000;
          box-shadow: var(--shadow-lg);
        `;
        document.body.appendChild(errorDiv);
      }
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    function hideConnectionError() {
      const errorDiv = document.getElementById('connectionError');
      if (errorDiv) {
        errorDiv.style.display = 'none';
      }
    }

    function updateConnectionStatus(status) {
      const statusDiv = document.getElementById('connectionStatus');
      if (!statusDiv) return;
      
      switch (status) {
        case 'connected':
          statusDiv.textContent = 'ğŸŸ¢ ì—°ê²°ë¨';
          statusDiv.style.background = 'var(--success-color)';
          break;
        case 'disconnected':
          statusDiv.textContent = 'ğŸ”´ ì—°ê²° ëŠê¹€';
          statusDiv.style.background = 'var(--danger-color)';
          break;
        case 'error':
          statusDiv.textContent = 'âš ï¸ ì—°ê²° ì˜¤ë¥˜';
          statusDiv.style.background = 'var(--danger-color)';
          break;
        default:
          statusDiv.textContent = 'ğŸŸ¡ ì—°ê²° ì¤‘...';
          statusDiv.style.background = 'var(--warning-color)';
      }
    }

    function updateCharCounter(inputId, counterId, maxLength) {
      const input = document.getElementById(inputId);
      const counter = document.getElementById(counterId);
      const length = input.value.length;
      
      counter.textContent = `${length}/${maxLength}`;
      
      counter.classList.remove('warning', 'danger');
      if (length > maxLength * 0.8) {
        counter.classList.add('warning');
      }
      if (length > maxLength * 0.95) {
        counter.classList.add('danger');
      }
    }

    function toggleTheme() {
      const body = document.body;
      const currentTheme = body.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      const themeBtn = document.querySelector('.theme-toggle');
      themeBtn.textContent = newTheme === 'dark' ? 'â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ' : 'ğŸŒ™ ë‹¤í¬ëª¨ë“œ';
    }

    function loadTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.body.setAttribute('data-theme', savedTheme);
      
      const themeBtn = document.querySelector('.theme-toggle');
      themeBtn.textContent = savedTheme === 'dark' ? 'â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ' : 'ğŸŒ™ ë‹¤í¬ëª¨ë“œ';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>